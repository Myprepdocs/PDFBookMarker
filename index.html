<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF BookMarker</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: var(--card-shadow-hover);
            margin: 2rem auto;
            max-width: 1400px;
        }

        .header-section {
            background: var(--primary-gradient);
            color: white;
            padding: 1.2rem 2rem;
            border-radius: 1rem 1rem 0 0;
            text-align: center;
        }

        .header-section h1 {
            font-weight: 700;
            margin-bottom: 0.3rem;
            font-size: 1.8rem;
        }

        .header-section p {
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .btn-kallidus {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }

        .btn-kallidus:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            color: white;
            transform: translateY(-1px);
        }

        .add-pdf-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }

        .add-pdf-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            color: white;
            transform: translateY(-1px);
        }

        .btn-small {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
        }

        .btn-small:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            color: white;
            transform: translateY(-1px);
        }

        .help-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .content-section {
            padding: 2rem;
            min-height: 600px;
        }

        .gallery-section {
            width: 100%;
        }

        .notes-section {
            flex: 1;
            background: #f8fafc;
            border-radius: 1rem;
            padding: 1.5rem;
            max-height: 800px;
            overflow-y: auto;
        }

        .modal-notes {
            max-width: 75%;
        }

        /* Ensure proper modal stacking */
        .modal.show {
            z-index: 1050;
        }

        .modal.show ~ .modal.show {
            z-index: 1060;
        }

        .modal-backdrop {
            z-index: 1040;
        }

        @media (max-width: 991px) {
            .modal-notes {
                max-width: 75%;
            }
        }

        .notes-section-modal {
            min-height: 60vh;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .notes-header-modal {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
            flex-shrink: 0;
        }

        .notes-list-modal {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .notes-search-modal {
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            padding: 0.5rem;
            transition: all 0.3s ease;
        }

        .notes-search-modal:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .notes-stats {
            font-weight: 500;
            color: #64748b;
        }

        .notes-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .notes-search {
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            padding: 0.5rem;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .notes-search:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .note-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            border-left: 4px solid #6366f1;
        }

        .note-item:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-1px);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .note-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
            margin: 0;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .note-btn {
            background: none;
            border: none;
            color: #6b7280;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .note-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .note-content {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .add-note-btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            width: 100%;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .add-note-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.75rem;
            font-weight: 500;
            color: #64748b;
        }

        .pdf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .video-section {
            border-top: 2px solid #e5e7eb;
            padding-top: 1.5rem;
        }

        .video-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            user-select: none;
            overflow: hidden;
        }

        .video-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
            border-color: #ef4444;
        }

        .video-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .video-item.drag-over {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .video-thumbnail {
            width: 100%;
            height: 192px;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            position: relative;
            overflow: hidden;
            padding: 1.2rem;
            text-align: center;
            background: #fef2f2;
            border: 2px solid #fecaca;
        }

        .video-thumbnail .play-icon {
            font-size: 2.5rem;
            color: #ef4444;
            margin-bottom: 0.75rem;
        }

        .video-item .pdf-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            line-height: 1.3;
            overflow: visible;
            display: block;
            text-align: center;
            flex-grow: 1;
            max-height: none;
            -webkit-line-clamp: unset;
            -webkit-box-orient: unset;
        }

        .pdf-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            user-select: none;
            overflow: hidden;
        }

        .pdf-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
            border-color: #6366f1;
        }

        .pdf-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .pdf-item.drag-over {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .pdf-thumbnail {
            width: 100%;
            height: 144px;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            position: relative;
            overflow: hidden;
            padding: 0.9rem;
            text-align: center;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
        }

        .pdf-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            line-height: 1.2;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-meta {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: auto;
        }

        .delete-btn {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .pdf-thumbnail:hover .delete-btn {
            display: flex;
        }
		
		.video-thumbnail:hover .delete-btn {
			display: flex;
		}

        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .drag-handle {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            background: rgba(0, 0, 0, 0.1);
            color: #6b7280;
            border: none;
            border-radius: 0.25rem;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: grab;
            font-size: 0.75rem;
        }

        .pdf-item:hover .drag-handle {
            display: flex;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .label-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 0.5rem 0.5rem;
            z-index: 5;
        }

        .label-selector {
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            padding: 0.5rem;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .label-selector:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .label-preview {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .label-color-picker {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #374151;
            transform: scale(1.15);
        }

        .color-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .label-management-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .label-management-item:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-1px);
        }

        .label-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-grow: 1;
        }

        .label-color-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
        }

        .label-details {
            flex-grow: 1;
        }

        .label-name {
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .label-usage {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }

        .label-actions {
            display: flex;
            gap: 0.5rem;
        }

        .label-action-btn {
            background: none;
            border: none;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .label-action-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .label-action-btn.delete:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .mobile-menu {
            display: none;
        }

        .hamburger-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 1.2rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hamburger-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            color: white;
        }

        .mobile-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow-hover);
            padding: 1rem;
            margin-top: 0.5rem;
            min-width: 200px;
            z-index: 1000;
        }

        .mobile-dropdown .btn {
            width: 100%;
            margin-bottom: 0.5rem;
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mobile-dropdown .btn:last-child {
            margin-bottom: 0;
        }

        .mobile-dropdown .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--card-shadow);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }


        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            z-index: 1100;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, #10b981, #059669);
        }

        .notification.error {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }

        .notification.warning {
            background: linear-gradient(45deg, #f59e0b, #d97706);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .context-menu {
            position: fixed;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
            padding: 0.5rem 0;
            z-index: 2000;
            min-width: 150px;
            display: none;
        }

        .context-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            color: #374151;
            font-size: 0.875rem;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .context-menu-item:hover {
            background-color: #f3f4f6;
        }

        .context-menu-item i {
            color: #6b7280;
        }

        .admin-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow-hover);
            padding: 0.5rem;
            margin-top: 1rem;
            min-width: 200px;
            z-index: 2000;
            border: 2px solid rgba(255, 255, 255, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .admin-dropdown-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .admin-dropdown-item {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-radius: 0.5rem;
            color: #374151;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }

        .admin-dropdown-item:hover {
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-1px);
        }

        .admin-dropdown-item:first-child {
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 0.25rem;
            padding-bottom: 0.75rem;
        }

        .admin-dropdown-item:first-child:hover {
            background: linear-gradient(45deg, #10b981, #059669);
        }

        /* iPad and tablet optimizations */
        @media (max-width: 1024px) and (min-width: 769px) {
            .pdf-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1.5rem;
            }
            
            .pdf-thumbnail, .video-thumbnail {
                height: 216px;
                padding: 1.44rem;
            }
            
            .pdf-title {
                font-size: 0.95rem;
                line-height: 1.4;
            }
            
            .video-item .pdf-title {
                font-size: 0.95rem;
                line-height: 1.4;
            }
        }

        /* Ensure tablets maintain full width search */
        @media (max-width: 1024px) and (min-width: 769px) {
            .search-bar {
                width: 100%;
                max-width: none;
            }
            
            .modal-notes {
                max-width: 75%;
            }
        }

        /* Mobile optimizations - phones only */
        @media (max-width: 768px) {
            body {
                margin: 0;
                padding: 0;
            }
            
            .container-fluid {
                padding: 0;
            }
            
            .main-container {
                margin: 0;
                margin-bottom: 4rem;
                border-radius: 0;
                min-height: 100vh;
                width: 100%;
                max-width: none;
            }
            
            .header-section {
                padding: 1rem;
                padding-left: 4rem;
                border-radius: 0;
                position: relative;
            }
            
            .header-section h1 {
                font-size: 1.5rem;
            }
            
            .header-section p {
                font-size: 0.85rem;
                margin-bottom: 1rem;
            }
            
            .desktop-buttons {
                display: none !important;
            }
            
            .mobile-menu {
                display: block;
                position: relative;
            }
            
            .content-section {
                padding: 1rem;
            }
            
            .gallery-section {
                width: 100%;
            }
            
            .modal-notes {
                max-width: 100%;
                margin: 0;
            }
            
            .modal-notes .modal-content {
                height: 100vh;
                border-radius: 0;
                border: none;
            }
            
            .notes-section-modal {
                min-height: calc(100vh - 120px);
                max-height: calc(100vh - 120px);
            }
            
            .pdf-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 1rem;
            }
            
            .pdf-item, .video-item {
                padding: 1rem;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            /* Hide drag handles on touch devices */
            .drag-handle {
                display: none !important;
            }
            
            .pdf-thumbnail, .video-thumbnail {
                height: 168px;
                font-size: 1.2rem;
                padding: 1rem;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                touch-action: manipulation;
            }
            
            .pdf-title {
                font-size: 0.875rem;
                line-height: 1.3;
                -webkit-line-clamp: 4;
                max-height: none;
                overflow: visible;
                display: block;
                text-align: center;
            }
            
            .video-item .pdf-title {
                font-size: 0.875rem;
                line-height: 1.3;
                overflow: visible;
                display: block;
                text-align: center;
                max-height: none;
                -webkit-line-clamp: unset;
                -webkit-box-orient: unset;
            }
            
            .floating-add {
                bottom: 3rem;
                right: 1rem;
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }
            
            .storage-indicator {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }
            
            .search-bar {
                width: 100%;
                padding: 0.5rem;
            }
            
            .search-input {
                font-size: 0.875rem;
                margin: 0 0.5rem;
            }
            
            .search-btn,
            .search-clear-btn {
                width: 32px;
                height: 32px;
                padding: 0.375rem;
            }
        }

        .summary-content {
            line-height: 1.6;
            color: #374151;
        }

        .summary-content h1,
        .summary-content h2,
        .summary-content h3,
        .summary-content h4,
        .summary-content h5,
        .summary-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: #1f2937;
        }

        .summary-content h1 { font-size: 1.5em; }
        .summary-content h2 { font-size: 1.3em; }
        .summary-content h3 { font-size: 1.2em; }
        .summary-content h4 { font-size: 1.1em; }

        .summary-content p {
            margin-bottom: 1em;
        }

        .summary-content ul,
        .summary-content ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }

        .summary-content li {
            margin-bottom: 0.25em;
        }

        .summary-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            margin: 1em 0;
            font-style: italic;
            color: #6b7280;
        }

        .summary-content code {
            background-color: #f3f4f6;
            padding: 0.125em 0.25em;
            border-radius: 0.25rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875em;
        }

        .summary-content pre {
            background-color: #f3f4f6;
            padding: 1em;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1em 0;
        }

        .summary-content pre code {
            background: none;
            padding: 0;
        }

        .summary-content a {
            color: #2563eb;
            text-decoration: none;
        }

        .summary-content a:hover {
            text-decoration: underline;
        }

        .summary-content strong {
            font-weight: 600;
        }

        .summary-content em {
            font-style: italic;
        }

        .summary-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 1.5em 0;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            width: 100%;
            max-width: none;
        }

        /* Desktop and large screens - 50% width */
        @media (min-width: 1025px) {
            .search-bar {
                width: 50%;
                max-width: 600px;
            }
        }

        .search-bar:focus-within {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.875rem;
            background: transparent;
            margin: 0 0.5rem;
        }

        .search-input::placeholder {
            color: #9ca3af;
        }

        .search-btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 0.5rem;
            padding: 0.375rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            transform: scale(1.05);
        }

        .search-clear-btn {
            background: #f3f4f6;
            border: none;
            color: #6b7280;
            border-radius: 0.5rem;
            padding: 0.375rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
        }

        .search-clear-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .search-results-info {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
            text-align: center;
        }

        .search-highlight {
            border: 3px solid #10b981 !important;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) !important;
            position: relative;
        }

        .search-highlight::before {
            content: '🔍';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #10b981;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            z-index: 10;
        }

        .search-no-results {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-style: italic;
        }

        .summary-search-highlight {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-weight: 600;
            border: 1px solid #fbbf24;
        }

        .summary-search-highlight.current {
            background-color: #fef2f2;
            color: #dc2626;
            border-color: #f87171;
            animation: pulse-highlight 1.5s ease-in-out 3;
        }

        @keyframes pulse-highlight {
            0%, 100% { 
                background-color: #fef2f2;
                transform: scale(1);
            }
            50% { 
                background-color: #fecaca;
                transform: scale(1.02);
            }
        }

        .storage-indicator {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e5e7eb;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #6b7280;
            text-align: center;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .storage-indicator.warning {
            background: rgba(251, 191, 36, 0.1);
            color: #d97706;
            border-top-color: #fbbf24;
        }

        .storage-indicator.danger {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border-top-color: #ef4444;
        }

        .storage-usage {
            font-weight: 500;
        }

        .storage-details {
            font-size: 0.75rem;
            margin-left: 0.5rem;
            opacity: 0.8;
        }

        /* Adjust main container to account for storage indicator */
        .main-container {
            margin-bottom: 3rem;
        }

        /* Touch feedback */
        @media (hover: none) and (pointer: coarse) {
            .pdf-item {
                -webkit-tap-highlight-color: rgba(99, 102, 241, 0.1);
            }
            
            .pdf-item:active {
                background: #f8fafc;
                transform: scale(0.98);
            }
            
            /* Remove hover states on touch devices */
            .pdf-item:hover,
            .video-item:hover {
                transform: none !important;
                box-shadow: var(--card-shadow) !important;
                border-color: transparent !important;
            }
        }

        /* iPad specific fixes */
        @media (pointer: coarse) {
            .pdf-thumbnail,
            .video-thumbnail {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                touch-action: manipulation;
                cursor: pointer !important;
            }
            
            .pdf-item:hover,
            .video-item:hover {
                transform: none !important;
                box-shadow: var(--card-shadow) !important;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header Section -->
            <div class="header-section position-relative">
                <button type="button" class="help-btn" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="bi bi-question-lg"></i>
                </button>
                
                <h1><i class="bi bi-bookmark-star me-2"></i>PDF BookMarker</h1>
                
                <div class="d-flex flex-wrap align-items-center justify-content-center btn-row desktop-buttons" style="gap: 1.5rem;">
                    <button id="kallidusLoginBtn" class="btn btn-kallidus" title="Open Kallidus Learning Platform">
                        <i class="bi bi-box-arrow-up-right me-2"></i>Kallidus Login
                    </button>
                    
                    <button id="notesBtn" class="btn btn-small" title="View and manage your notes">
                        <i class="bi bi-journal-text me-1"></i>Your Notes
                    </button>
                    <button id="reloadNotesBtn" class="btn btn-small" title="Reload your notes from file">
                        <i class="bi bi-arrow-clockwise me-1"></i>Reload Notes
                    </button>
                    <button id="saveNotesBtn" class="btn btn-small" title="Save your notes to file">
                        <i class="bi bi-floppy me-1"></i>Save Notes
                    </button>
                </div>

                <!-- Admin Dropdown Menu (Hidden by default) -->
                <div id="adminDropdown" class="admin-dropdown" style="display: none;">
                    <div class="admin-dropdown-content">
                        <button id="adminExportBtn" class="admin-dropdown-item">
                            <i class="bi bi-download me-2"></i>Export Central Data
                        </button>
                        <button id="adminAddPdfBtn" class="admin-dropdown-item">
                            <i class="bi bi-plus-circle me-2"></i>Add PDF
                        </button>
                        <button id="adminAddVideoBtn" class="admin-dropdown-item">
                            <i class="bi bi-play-circle me-2"></i>Add Video
                        </button>
                        <button id="adminManageLabelsBtn" class="admin-dropdown-item">
                            <i class="bi bi-tags me-2"></i>Manage Labels
                        </button>
                    </div>
                </div>

                <div class="mobile-menu">
                    <button id="mobileMenuBtn" class="hamburger-btn" title="Menu">
                        <i class="bi bi-list"></i>
                    </button>
                    <div id="mobileDropdown" class="mobile-dropdown" style="display: none;">
                        <button id="mobileKallidusBtn" class="btn" title="Open Kallidus Learning Platform">
                            <i class="bi bi-box-arrow-up-right me-2"></i>Kallidus Login
                        </button>
                        <button id="mobileNotesBtn" class="btn" title="View and manage your notes">
                            <i class="bi bi-journal-text me-2"></i>Your Notes
                        </button>
                        <button id="mobileReloadNotesBtn" class="btn" title="Reload your notes from file">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reload Notes
                        </button>
                        <button id="mobileSaveNotesBtn" class="btn" title="Save your notes to file">
                            <i class="bi bi-floppy me-2"></i>Save Notes
                        </button>
                    </div>
                </div>
                
                <input type="file" id="notesImportFile" accept=".json" style="display: none;">
            </div>

            <!-- Content Section -->
            <div class="content-section">
                <!-- Gallery Section -->
                <div class="gallery-section">
                    <!-- Stats Bar -->
                    <div class="stats-bar">
                        <div>
                            <i class="bi bi-collection me-2"></i>
                            <span id="pdfCount">0</span> PDFs
                        </div>
                        <div class="d-none d-md-block">
                            <i class="bi bi-clock me-2"></i>
                            Last: <span id="lastAdded">None</span>
                        </div>
                    </div>

                    <!-- Summary Search Bar -->
                    <div class="search-bar">
                        <i class="bi bi-search" style="color: #9ca3af;"></i>
                        <input type="text" id="summarySearchInput" class="search-input" 
                               placeholder="Search in summaries..." />
                        <button id="summarySearchBtn" class="search-btn" title="Search summaries">
                            <i class="bi bi-search"></i>
                        </button>
                        <button id="summarySearchClear" class="search-clear-btn" title="Clear search">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>

                    <!-- Search Results Info -->
                    <div id="searchResultsInfo" class="search-results-info" style="display: none;"></div>

                    <!-- PDF Grid -->
                    <div id="pdfGrid" class="pdf-grid">
                        <div class="empty-state">
                            <i class="bi bi-file-earmark-plus"></i>
                            <h4>Start Building Your Collection</h4>
                            <p>Add PDFs from Kallidus to create a persistent gallery</p>
                        </div>
                    </div>

                    <!-- Video Section -->
                    <div class="video-section mt-4">
                        <div class="stats-bar">
                            <div>
                                <i class="bi bi-play-circle me-2"></i>
                                <span id="videoCount">0</span> Videos
                            </div>
                            <div class="d-none d-md-block">
                                <i class="bi bi-clock me-2"></i>
                                Last: <span id="lastVideoAdded">None</span>
                            </div>
                        </div>

                        <!-- Video Grid -->
                        <div id="videoGrid" class="pdf-grid">
                            <div class="empty-state">
                                <i class="bi bi-play-circle-fill"></i>
                                <h4>Add Training Videos</h4>
                                <p>Collect video links for your training resources</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- PDF Modal -->
    <div class="modal fade" id="pdfModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Add PDF to Collection
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="pdfForm">
                        <div class="mb-3">
                            <label for="pdfUrl" class="form-label">PDF URL</label>
                            <input type="url" class="form-control" id="pdfUrl" required 
                                   placeholder="https://example.com/document.pdf">
                            <div class="form-text">Paste the link to the PDF document</div>
                        </div>
                        <div class="mb-3">
                            <label for="pdfLabel" class="form-label">Label (optional)</label>
                            <div class="d-flex gap-2">
                                <select class="form-select label-selector" id="pdfLabel">
                                    <option value="">No label</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" id="newPdfLabelBtn">
                                    <i class="bi bi-plus"></i> New
                                </button>
                            </div>
                            <div id="pdfLabelPreview"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePdfBtn">
                        <i class="bi bi-plus-circle me-2"></i>Add PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-play-circle me-2"></i>Add Video to Collection
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="videoForm">
                        <div class="mb-3">
                            <label for="videoTitle" class="form-label">Video Title</label>
                            <input type="text" class="form-control" id="videoTitle" required 
                                   placeholder="Enter a descriptive title for the video">
                        </div>
                        <div class="mb-3">
                            <label for="videoUrl" class="form-label">Video URL</label>
                            <input type="url" class="form-control" id="videoUrl" required 
                                   placeholder="https://example.com/video-link">
                            <div class="form-text">Paste the link to the training video</div>
                        </div>
                        <div class="mb-3">
                            <label for="videoLabel" class="form-label">Label (optional)</label>
                            <div class="d-flex gap-2">
                                <select class="form-select label-selector" id="videoLabel">
                                    <option value="">No label</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" id="newVideoLabelBtn">
                                    <i class="bi bi-plus"></i> New
                                </button>
                            </div>
                            <div id="videoLabelPreview"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveVideoBtn">
                        <i class="bi bi-plus-circle me-2"></i>Add Video
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Label Management Modal -->
    <div class="modal fade" id="labelManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-tags me-2"></i>Manage Labels
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <p class="mb-0 text-muted">Organize your collection with custom labels</p>
                        <button id="createNewLabelBtn" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus me-1"></i>Create Label
                        </button>
                    </div>
                    
                    <div id="labelsManagementList">
                        <div class="empty-state">
                            <i class="bi bi-tags"></i>
                            <h5>No Labels Created</h5>
                            <p>Create your first label to organize your collection</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Label Creation/Edit Modal -->
    <div class="modal fade" id="labelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="labelModalTitle">
                        <i class="bi bi-tag me-2"></i>Create New Label
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="labelForm">
                        <div class="mb-3">
                            <label for="labelName" class="form-label">Label Name</label>
                            <input type="text" class="form-control" id="labelName" required 
                                   placeholder="Enter label name (e.g., 'Training', 'Important')">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Choose Color</label>
                            <div class="label-color-picker" id="colorPicker">
                                <div class="color-option" data-color="#ef4444" style="background-color: #ef4444;"></div>
                                <div class="color-option" data-color="#f97316" style="background-color: #f97316;"></div>
                                <div class="color-option" data-color="#eab308" style="background-color: #eab308;"></div>
                                <div class="color-option" data-color="#22c55e" style="background-color: #22c55e;"></div>
                                <div class="color-option" data-color="#06b6d4" style="background-color: #06b6d4;"></div>
                                <div class="color-option selected" data-color="#3b82f6" style="background-color: #3b82f6;"></div>
                                <div class="color-option" data-color="#6366f1" style="background-color: #6366f1;"></div>
                                <div class="color-option" data-color="#8b5cf6" style="background-color: #8b5cf6;"></div>
                                <div class="color-option" data-color="#ec4899" style="background-color: #ec4899;"></div>
                                <div class="color-option" data-color="#64748b" style="background-color: #64748b;"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preview</label>
                            <div>
                                <span class="label-preview" id="labelPreview" style="background-color: #3b82f6;">Sample Label</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveLabelBtn">
                        <i class="bi bi-plus-circle me-2"></i><span id="saveLabelBtnText">Create Label</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="noteModalTitle">Add New Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="noteForm">
                        <div class="mb-3">
                            <label for="noteTitle" class="form-label">Note Title</label>
                            <input type="text" class="form-control" id="noteTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="noteContent" class="form-label">Content</label>
                            <textarea class="form-control" id="noteContent" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="notePdfLink" class="form-label">Link to Resource (optional)</label>
                            <select class="form-select" id="notePdfLink">
                                <option value="">No resource selected</option>
                            </select>
                            <div class="form-text">Link this note to a specific PDF or video</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNoteBtn">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal fade" id="summaryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="summaryModalTitle">
                        <i class="bi bi-file-text me-2"></i>Resource Summary
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="summaryContent" class="p-3">
                        <p class="text-muted">No summary available for this resource.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Summary Modal -->
    <div class="modal fade" id="editSummaryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Edit Summary
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="summaryForm">
                        <div class="mb-3">
                            <label for="resourceTitle" class="form-label">Resource</label>
                            <input type="text" class="form-control" id="resourceTitle" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="summaryText" class="form-label">Summary</label>
                            <textarea class="form-control" id="summaryText" rows="6" 
                                      placeholder="Enter a summary or notes about this resource...

You can use **Markdown** formatting:
• **bold text** or __bold text__
• *italic text* or _italic text_
• # Heading 1
• ## Heading 2
• - List item
• [Link text](URL)
• `code snippet`"></textarea>
                            <div class="form-text">
                                <i class="bi bi-markdown me-1"></i>
                                Markdown formatting supported: **bold**, *italic*, # headings, - lists, [links](url), `code`
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSummaryBtn">
                        <i class="bi bi-check-circle me-2"></i>Save Summary
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Label Modal -->
    <div class="modal fade" id="changeLabelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-tag me-2"></i>Change Label
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changeLabelForm">
                        <div class="mb-3">
                            <label for="changeResourceTitle" class="form-label">Resource</label>
                            <input type="text" class="form-control" id="changeResourceTitle" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="currentLabel" class="form-label">Current Label</label>
                            <div id="currentLabelDisplay" class="p-2 bg-light rounded">
                                <span class="text-muted">No label</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="newLabelSelect" class="form-label">New Label</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="newLabelSelect">
                                    <option value="">No label</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" id="newLabelFromChangeBtn">
                                    <i class="bi bi-plus"></i> New
                                </button>
                            </div>
                            <div id="newLabelPreview" class="mt-2"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveNewLabelBtn">
                        <i class="bi bi-check-circle me-2"></i>Change Label
                    </button>
                </div>
            </div>
        </div>
    </div>

	<div id="contextMenu" class="context-menu">
		<button class="context-menu-item" id="openPdfMenuItem">
			<i class="bi bi-box-arrow-up-right"></i>
			Open 
		</button>
		<button class="context-menu-item" id="openSummaryMenuItem">
			<i class="bi bi-file-text"></i>
			Open Summary
		</button>
		<button class="context-menu-item" id="editSummaryMenuItem">
			<i class="bi bi-pencil-square"></i>
			Edit Summary
		</button>
		<button class="context-menu-item" id="changeLabelMenuItem">
			<i class="bi bi-tag"></i>
			Change Label
		</button>
	</div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1">
        <div class="modal-dialog modal-notes">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-journal-text me-2"></i>Your Notes
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Notes Section Content -->
                    <div class="notes-section-modal">
                        <div class="notes-header-modal">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="notes-stats">
                                    <i class="bi bi-journal me-2"></i>
                                    <span id="notesCount">0</span> Notes
                                </div>
                                <button id="addNoteBtnModal" class="btn btn-primary">
                                    <i class="bi bi-plus me-2"></i>Add New Note
                                </button>
                            </div>
                            <input type="text" id="notesSearchModal" class="form-control notes-search-modal" 
                                   placeholder="Search notes...">
                        </div>
                        
                        <div id="notesListModal" class="notes-list-modal">
                            <div class="empty-state">
                                <i class="bi bi-journal-plus"></i>
                                <h5>No Notes Yet</h5>
                                <p>Start taking notes about your training</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle me-2"></i>How to Use Training Collection Manager
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-1-circle me-2"></i>Getting Started
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Click "Kallidus Login" to access the learning platform</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Browse through the available PDFs and videos in the collection</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Single click any thumbnail to open the PDF or video</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Double click thumbnails to view detailed summaries</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-2-circle me-2"></i>Browsing Your Collection
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Single click any thumbnail to open the PDF/video directly</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Double click thumbnails to view formatted summaries</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Right-click or long press for summary and label options</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Look for colored label bars to identify content categories</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-3-circle me-2"></i>Summary Search
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Use search box above thumbnails to find content</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Type keywords to search through summary content</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Matching thumbnails are highlighted in green</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Double-click highlighted items to see highlighted text in summaries</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Click X button to clear search and highlights</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-4-circle me-2"></i>Taking Personal Notes
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Click "Your Notes" to open the notes modal</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Add your personal notes about training content</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Link notes to specific PDFs/videos for easy reference</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Search through your notes to find information quickly</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Click note titles to expand/collapse content</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-5-circle me-2"></i>Notes Management
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Your personal notes are stored separately from the main collection</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Click "Save Notes" to download your notes to a backup file</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Click "Reload Notes" to import notes from a previously saved file</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Your notes are preserved when the app updates with new content</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-6-circle me-2"></i>Understanding Labels
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Look for colored bars on thumbnails to identify content types</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Labels help organize content by topic or importance</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Common labels include "Training", "Important", "Safety", etc.</li>
                                        <li><i class="bi bi-arrow-right text-success me-2"></i>Use labels to quickly find content in specific categories</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Pro Tip:</strong> Use the search feature to quickly find specific training topics across your entire collection!
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-phone me-2"></i>
                        <strong>Mobile Tips:</strong> Single tap thumbnails to open PDFs/videos directly. Double tap to view summaries. Long press for 0.5 seconds to open the context menu.
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-tablet me-2"></i>
                        <strong>iPad Tips:</strong> Optimized for iPad Safari with immediate tap response. Use hamburger menu (top-left) for navigation. Long press thumbnails for context menu options.
                    </div>
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-search me-2"></i>
                        <strong>Search Tip:</strong> Use the search box above thumbnails to quickly find resources by searching through your summary content. Perfect for locating specific topics or keywords across your entire collection!
                    </div>
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-tag me-2"></i>
                        <strong>Label Tips:</strong> Use labels like "Completed", "In Progress", "Important", or by topic like "Safety Training", "IT Skills" to organize your learning materials effectively!
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-markdown me-2"></i>
                        <strong>Markdown Support:</strong> Your summaries support full Markdown formatting! Use **bold**, *italic*, # headings, - lists, [links](url), and `code` to create rich, formatted notes.
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        <strong>Search Highlighting:</strong> When you search summaries and find matches, double-clicking those highlighted thumbnails will automatically scroll to and highlight the found text within the summary modal!
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-cloud-download me-2"></i>
                        <strong>Auto-Update System:</strong> The app automatically checks for and loads updated collection data when you start it. Your personal notes are always preserved during these updates.
                    </div>
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-journal-text me-2"></i>
                        <strong>Notes Backup:</strong> Use "Save Notes" regularly to backup your personal notes. The main collection (PDFs, videos, summaries, labels) is managed centrally and updates automatically.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Storage Usage Indicator -->
    <div id="storageIndicator" class="storage-indicator">
        <span class="storage-usage">Storage: <span id="storageUsed">0 KB</span> / <span id="storageLimit">~10 MB</span> (<span id="storagePercent">0%</span>)</span>
        <span class="storage-details d-none d-md-inline">| <span id="totalItems">0</span> items</span>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // PDF.js worker setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        class PDFCompanion {
            constructor() {
                this.pdfCollection = this.loadFromStorage();
                this.videoCollection = this.loadVideosFromStorage();
                this.notesCollection = this.loadNotesFromStorage();
                this.labelsCollection = this.loadLabelsFromStorage();
                this.summariesCollection = this.loadSummariesFromStorage();
                this.sortable = null;
                this.videoSortable = null;
                this.currentEditingNote = null;
                this.currentModalType = null; // 'pdf' or 'video'
                this.currentEditingLabel = null; // For editing labels
                this.selectedColor = '#3b82f6'; // Default color for new labels
                this.currentSummaryResource = null; // For editing summaries
                this.clickTimeout = null; // For distinguishing single vs double clicks
				this.lastTapData = {}; // For tracking double taps per thumbnail
                this.currentSearchTerm = ''; // Track current search term for highlighting
                this.adminClickCount = 0; // For secret admin function
                this.adminClickTimer = null; // Timer for admin clicks
                this.shouldRestoreNotesModal = false; // For handling modal stacking on mobile
                this.elements = {
                    kallidusLoginBtn: document.getElementById('kallidusLoginBtn'),
                    reloadNotesBtn: document.getElementById('reloadNotesBtn'),
                    saveNotesBtn: document.getElementById('saveNotesBtn'),
                    notesImportFile: document.getElementById('notesImportFile'),
                    pdfGrid: document.getElementById('pdfGrid'),
                    pdfCount: document.getElementById('pdfCount'),
                    lastAdded: document.getElementById('lastAdded'),
                    notification: document.getElementById('notification'),
                    // Admin elements
                    adminDropdown: document.getElementById('adminDropdown'),
                    adminExportBtn: document.getElementById('adminExportBtn'),
                    adminAddPdfBtn: document.getElementById('adminAddPdfBtn'),
                    adminAddVideoBtn: document.getElementById('adminAddVideoBtn'),
                    adminManageLabelsBtn: document.getElementById('adminManageLabelsBtn'),
                    // Mobile menu elements
                    mobileMenuBtn: document.getElementById('mobileMenuBtn'),
                    mobileDropdown: document.getElementById('mobileDropdown'),
                    mobileKallidusBtn: document.getElementById('mobileKallidusBtn'),
                    mobileNotesBtn: document.getElementById('mobileNotesBtn'),
                    mobileReloadNotesBtn: document.getElementById('mobileReloadNotesBtn'),
                    mobileSaveNotesBtn: document.getElementById('mobileSaveNotesBtn'),
                    // PDF elements
                    pdfModal: document.getElementById('pdfModal'),
                    pdfForm: document.getElementById('pdfForm'),
                    pdfUrl: document.getElementById('pdfUrl'),
                    pdfLabel: document.getElementById('pdfLabel'),
                    pdfLabelPreview: document.getElementById('pdfLabelPreview'),
                    newPdfLabelBtn: document.getElementById('newPdfLabelBtn'),
                    savePdfBtn: document.getElementById('savePdfBtn'),
                    // Video elements
                    videoGrid: document.getElementById('videoGrid'),
                    videoCount: document.getElementById('videoCount'),
                    lastVideoAdded: document.getElementById('lastVideoAdded'),
                    videoModal: document.getElementById('videoModal'),
                    videoForm: document.getElementById('videoForm'),
                    videoTitle: document.getElementById('videoTitle'),
                    videoUrl: document.getElementById('videoUrl'),
                    videoLabel: document.getElementById('videoLabel'),
                    videoLabelPreview: document.getElementById('videoLabelPreview'),
                    newVideoLabelBtn: document.getElementById('newVideoLabelBtn'),
                    saveVideoBtn: document.getElementById('saveVideoBtn'),
                    // Label elements
                    labelManagementModal: document.getElementById('labelManagementModal'),
                    labelsManagementList: document.getElementById('labelsManagementList'),
                    createNewLabelBtn: document.getElementById('createNewLabelBtn'),
                    labelModal: document.getElementById('labelModal'),
                    labelForm: document.getElementById('labelForm'),
                    labelName: document.getElementById('labelName'),
                    colorPicker: document.getElementById('colorPicker'),
                    labelPreview: document.getElementById('labelPreview'),
                    saveLabelBtn: document.getElementById('saveLabelBtn'),
                    saveLabelBtnText: document.getElementById('saveLabelBtnText'),
                    labelModalTitle: document.getElementById('labelModalTitle'),
                    // Notes elements
                    notesBtn: document.getElementById('notesBtn'),
                    notesModal: document.getElementById('notesModal'),
                    addNoteBtnModal: document.getElementById('addNoteBtnModal'),
                    notesListModal: document.getElementById('notesListModal'),
                    notesSearchModal: document.getElementById('notesSearchModal'),
                    notesCount: document.getElementById('notesCount'),
                    noteModal: document.getElementById('noteModal'),
                    noteForm: document.getElementById('noteForm'),
                    noteTitle: document.getElementById('noteTitle'),
                    noteContent: document.getElementById('noteContent'),
                    notePdfLink: document.getElementById('notePdfLink'),
                    saveNoteBtn: document.getElementById('saveNoteBtn'),
                    noteModalTitle: document.getElementById('noteModalTitle'),
                    // Summary elements
                    summaryModal: document.getElementById('summaryModal'),
                    summaryModalTitle: document.getElementById('summaryModalTitle'),
                    summaryContent: document.getElementById('summaryContent'),
                    editSummaryModal: document.getElementById('editSummaryModal'),
                    summaryForm: document.getElementById('summaryForm'),
                    resourceTitle: document.getElementById('resourceTitle'),
                    summaryText: document.getElementById('summaryText'),
                    saveSummaryBtn: document.getElementById('saveSummaryBtn'),
                    contextMenu: document.getElementById('contextMenu'),
					openPdfMenuItem: document.getElementById('openPdfMenuItem'),
					openSummaryMenuItem: document.getElementById('openSummaryMenuItem'),
                    editSummaryMenuItem: document.getElementById('editSummaryMenuItem'),
                    changeLabelMenuItem: document.getElementById('changeLabelMenuItem'),
                    // Change label modal elements
                    changeLabelModal: document.getElementById('changeLabelModal'),
                    changeLabelForm: document.getElementById('changeLabelForm'),
                    changeResourceTitle: document.getElementById('changeResourceTitle'),
                    currentLabelDisplay: document.getElementById('currentLabelDisplay'),
                    newLabelSelect: document.getElementById('newLabelSelect'),
                    newLabelFromChangeBtn: document.getElementById('newLabelFromChangeBtn'),
                    newLabelPreview: document.getElementById('newLabelPreview'),
                    saveNewLabelBtn: document.getElementById('saveNewLabelBtn'),
                    // Storage indicator elements
                    storageIndicator: document.getElementById('storageIndicator'),
                    storageUsed: document.getElementById('storageUsed'),
                    storageLimit: document.getElementById('storageLimit'),
                    storagePercent: document.getElementById('storagePercent'),
                    totalItems: document.getElementById('totalItems'),
                    // Summary search elements
                    summarySearchInput: document.getElementById('summarySearchInput'),
                    summarySearchBtn: document.getElementById('summarySearchBtn'),
                    summarySearchClear: document.getElementById('summarySearchClear'),
                    searchResultsInfo: document.getElementById('searchResultsInfo')
                };
                
                this.noteModal = new bootstrap.Modal(this.elements.noteModal);
                this.notesModal = new bootstrap.Modal(this.elements.notesModal);
                this.videoModal = new bootstrap.Modal(this.elements.videoModal);
                this.pdfModal = new bootstrap.Modal(this.elements.pdfModal);
                this.labelModal = new bootstrap.Modal(this.elements.labelModal);
                this.labelManagementModal = new bootstrap.Modal(this.elements.labelManagementModal);
                this.summaryModal = new bootstrap.Modal(this.elements.summaryModal);
                this.editSummaryModal = new bootstrap.Modal(this.elements.editSummaryModal);
                this.changeLabelModal = new bootstrap.Modal(this.elements.changeLabelModal);
                this.init();
            }

            async init() {
                // Configure marked.js for security
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false, // We'll handle sanitization ourselves
                    smartLists: true,
                    smartypants: false
                });
                
                // Detect and handle iPad/touch device quirks
                this.setupTouchDeviceOptimizations();
                
                // Check for central data file and handle version updates
                await this.checkAndLoadCentralData();
                
                this.bindEvents();
                this.renderGallery();
                this.renderVideos();
                this.updateStats();
                this.updateResourceDropdown();
                this.updateLabelDropdowns();
                this.updateStorageIndicator();
                this.initSortable();
                this.initVideoSortable();
                this.initializeLabelColorPicker();
            }

            setupTouchDeviceOptimizations() {
                // Enhanced touch device detection
                const isTouch = (
                    'ontouchstart' in window || 
                    navigator.maxTouchPoints > 0 || 
                    /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)
                );
                
                if (isTouch) {
                    // Add touch device class to body for CSS targeting
                    document.body.classList.add('touch-device');
                    
                    // Disable hover effects that interfere with touch
                    const style = document.createElement('style');
                    style.textContent = `
                        .touch-device .pdf-item:hover,
                        .touch-device .video-item:hover {
                            transform: none !important;
                            box-shadow: var(--card-shadow) !important;
                            border-color: transparent !important;
                        }
                        .touch-device .pdf-thumbnail:hover,
                        .touch-device .video-thumbnail:hover {
                            background: #f8fafc !important;
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            bindEvents() {
                this.elements.kallidusLoginBtn.addEventListener('click', () => this.openKallidus());
                this.elements.saveNotesBtn.addEventListener('click', () => this.saveNotesToFile());
                this.elements.reloadNotesBtn.addEventListener('click', () => this.triggerNotesImport());
                this.elements.notesImportFile.addEventListener('change', (e) => this.importNotesFromFile(e));
                
                // Admin dropdown events
                this.elements.adminExportBtn.addEventListener('click', () => {
                    this.exportCentralData();
                    this.hideAdminDropdown();
                });
                this.elements.adminAddPdfBtn.addEventListener('click', () => {
                    this.openPdfModal();
                    this.hideAdminDropdown();
                });
                this.elements.adminAddVideoBtn.addEventListener('click', () => {
                    this.openVideoModal();
                    this.hideAdminDropdown();
                });
                this.elements.adminManageLabelsBtn.addEventListener('click', () => {
                    this.openLabelManagementModal();
                    this.hideAdminDropdown();
                });
                
                // Mobile menu events
                this.elements.mobileMenuBtn.addEventListener('click', () => this.toggleMobileMenu());
                this.elements.mobileKallidusBtn.addEventListener('click', () => {
                    this.openKallidus();
                    this.closeMobileMenu();
                });
                this.elements.mobileNotesBtn.addEventListener('click', () => {
                    this.openNotesModal();
                    this.closeMobileMenu();
                });
                this.elements.mobileReloadNotesBtn.addEventListener('click', () => {
                    this.triggerNotesImport();
                    this.closeMobileMenu();
                });
                this.elements.mobileSaveNotesBtn.addEventListener('click', () => {
                    this.saveNotesToFile();
                    this.closeMobileMenu();
                });
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.elements.mobileMenuBtn.contains(e.target) && !this.elements.mobileDropdown.contains(e.target)) {
                        this.closeMobileMenu();
                    }
                    // Hide admin dropdown when clicking outside
                    if (!e.target.closest('.admin-dropdown') && !e.target.closest('.header-section h1')) {
                        this.hideAdminDropdown();
                    }
                });
                
                // PDF events
                this.elements.savePdfBtn.addEventListener('click', () => this.savePdf());
                this.elements.newPdfLabelBtn.addEventListener('click', () => this.openLabelModal('pdf'));
                this.elements.pdfLabel.addEventListener('change', () => this.updatePdfLabelPreview());
                
                // Video events
                this.elements.saveVideoBtn.addEventListener('click', () => this.saveVideo());
                this.elements.newVideoLabelBtn.addEventListener('click', () => this.openLabelModal('video'));
                this.elements.videoLabel.addEventListener('change', () => this.updateVideoLabelPreview());
                
                // Label management events
                this.elements.createNewLabelBtn.addEventListener('click', () => this.openLabelModal('management'));
                this.elements.saveLabelBtn.addEventListener('click', () => this.saveLabel());
                this.elements.labelName.addEventListener('input', () => this.updateLabelPreview());
                
                // Notes events
                this.elements.notesBtn.addEventListener('click', () => this.openNotesModal());
                this.elements.addNoteBtnModal.addEventListener('click', () => this.openNoteModal());
                this.elements.saveNoteBtn.addEventListener('click', () => this.saveNote());
                this.elements.notesSearchModal.addEventListener('input', (e) => this.searchNotes(e.target.value));
                
                // Handle modal stacking for mobile - restore notes modal after note modal closes
                this.elements.noteModal.addEventListener('hidden.bs.modal', () => {
                    if (this.shouldRestoreNotesModal) {
                        this.shouldRestoreNotesModal = false;
                        setTimeout(() => {
                            this.renderNotes(); // Re-render notes to reflect any changes
                            this.notesModal.show();
                        }, 100);
                    }
                });
                
                // Ensure notes are rendered when notes modal is shown
                this.elements.notesModal.addEventListener('shown.bs.modal', () => {
                    this.renderNotes();
                });
                
                // Summary events
                this.elements.editSummaryMenuItem.addEventListener('click', () => this.openEditSummaryModal());
                this.elements.saveSummaryBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.saveSummary();
                });
                
                // Change label events
                this.elements.changeLabelMenuItem.addEventListener('click', () => this.openChangeLabelModal());
                this.elements.saveNewLabelBtn.addEventListener('click', () => this.saveNewLabel());
                this.elements.newLabelFromChangeBtn.addEventListener('click', () => this.openLabelModal('change'));
                this.elements.newLabelSelect.addEventListener('change', () => this.updateNewLabelPreview());
				
				// New context menu events
				this.elements.openPdfMenuItem.addEventListener('click', () => this.handleOpenPdf());
				this.elements.openSummaryMenuItem.addEventListener('click', () => this.handleOpenSummary());
                
                // Clear currentSummaryResource when modals are closed
                this.elements.editSummaryModal.addEventListener('hidden.bs.modal', () => {
                    this.currentSummaryResource = null;
                });
                
                this.elements.changeLabelModal.addEventListener('hidden.bs.modal', () => {
                    this.currentSummaryResource = null;
                });
                
                // Context menu events
                document.addEventListener('click', (e) => {
                    // Don't clear currentSummaryResource if clicking inside a modal or the context menu
                    if (!e.target.closest('.modal') && !e.target.closest('.context-menu')) {
                        if (!this.elements.editSummaryModal.classList.contains('show')) {
                            this.currentSummaryResource = null;
                        }
                    }
                    // Always hide context menu when clicking outside
                    if (!e.target.closest('.context-menu')) {
                        this.hideContextMenu();
                    }
                });
                document.addEventListener('contextmenu', (e) => this.handleContextMenu(e));
                
                // Touch events for mobile context menu (simplified without drag/drop interference)
                let touchStartTime = 0;
                let touchStartCount = 0;
                let longPressTimeout = null;
                let touchStartTarget = null;
                let hasMoved = false;
                let initialTouchPos = { x: 0, y: 0 };
                
                document.addEventListener('touchstart', (e) => {
                    touchStartTime = Date.now();
                    touchStartCount = e.touches.length;
                    touchStartTarget = e.target;
                    hasMoved = false;
                    
                    if (e.touches.length > 0) {
                        initialTouchPos.x = e.touches[0].clientX;
                        initialTouchPos.y = e.touches[0].clientY;
                    }
                    
                    // Set up long press detection for single finger on thumbnails
                    if (touchStartCount === 1) {
                        const thumbnail = touchStartTarget.closest('.pdf-thumbnail, .video-thumbnail');
                        if (thumbnail) {
                            longPressTimeout = setTimeout(() => {
                                if (!hasMoved) {
                                    // Create synthetic event for context menu positioning
                                    const syntheticEvent = {
                                        preventDefault: () => {},
                                        target: touchStartTarget,
                                        touches: e.touches,
                                        clientX: e.touches[0].clientX,
                                        clientY: e.touches[0].clientY
                                    };
                                    this.handleContextMenu(syntheticEvent);
                                    
                                    // Add haptic feedback if available
                                    if (navigator.vibrate) {
                                        navigator.vibrate(50);
                                    }
                                }
                            }, 500); // Reduced for better iPad experience
                        }
                    }
                }, { passive: false });
                
                document.addEventListener('touchmove', (e) => {
                    // Check if moved significantly (more than 10px)
                    if (e.touches.length > 0) {
                        const deltaX = Math.abs(e.touches[0].clientX - initialTouchPos.x);
                        const deltaY = Math.abs(e.touches[0].clientY - initialTouchPos.y);
                        if (deltaX > 10 || deltaY > 10) {
                            hasMoved = true;
                        }
                    }
                    
                    // Cancel long press if finger moves
                    if (hasMoved && longPressTimeout) {
                        clearTimeout(longPressTimeout);
                        longPressTimeout = null;
                    }
                }, { passive: true });
                
                document.addEventListener('touchend', (e) => {
                    const touchDuration = Date.now() - touchStartTime;
                    
                    // Clear long press timeout
                    if (longPressTimeout) {
                        clearTimeout(longPressTimeout);
                        longPressTimeout = null;
                    }
                    
                    // Two-finger tap detection (only if no movement)
                    if (touchStartCount === 2 && !hasMoved && touchDuration > 100 && touchDuration < 800) {
                        const thumbnail = touchStartTarget.closest('.pdf-thumbnail, .video-thumbnail');
                        if (thumbnail) {
                            e.preventDefault();
                            const syntheticEvent = {
                                preventDefault: () => {},
                                target: touchStartTarget,
                                changedTouches: e.changedTouches,
                                clientX: e.changedTouches[0].clientX,
                                clientY: e.changedTouches[0].clientY
                            };
                            this.handleContextMenu(syntheticEvent);
                        }
                    }
                }, { passive: false });
                
                // Summary search events
                this.elements.summarySearchBtn.addEventListener('click', () => this.searchSummaries());
                this.elements.summarySearchClear.addEventListener('click', () => this.clearSummarySearch());
                this.elements.summarySearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchSummaries();
                    }
                });
                this.elements.summarySearchInput.addEventListener('input', (e) => {
                    // Clear search if input is empty
                    if (!e.target.value.trim()) {
                        this.clearSummarySearch();
                    }
                });
                
                // Secret admin function - triple click on app title
                const appTitle = document.querySelector('.header-section h1');
                if (appTitle) {
                    appTitle.addEventListener('click', (e) => this.handleAdminClick(e));
                    appTitle.style.cursor = 'default';
                }
                
                // Keyboard shortcuts and other global events
                document.addEventListener('keydown', (e) => {
                    // Hide context menu on Escape
                    if (e.key === 'Escape') {
                        this.hideContextMenu();
                        this.hideAdminDropdown();
                    }
                });
            }

            initSortable() {
                if (this.sortable) {
                    this.sortable.destroy();
                }
                
                // Don't enable drag and drop on touch devices
                const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                if (isTouchDevice) {
                    return;
                }
                
                const grid = this.elements.pdfGrid;
                if (grid.children.length > 0 && !grid.querySelector('.empty-state')) {
                    this.sortable = Sortable.create(grid, {
                        animation: 150,
                        ghostClass: 'dragging',
                        chosenClass: 'drag-over',
                        handle: '.pdf-item',
                        touchStartThreshold: 10,
                        onEnd: (evt) => {
                            if (evt.oldIndex !== evt.newIndex) {
                                // Reorder the collection array
                                const movedItem = this.pdfCollection.splice(evt.oldIndex, 1)[0];
                                this.pdfCollection.splice(evt.newIndex, 0, movedItem);
                                this.saveToStorage();
                                this.showNotification('PDF order updated', 'success');
                            }
                        }
                    });
                }
            }

            initVideoSortable() {
                if (this.videoSortable) {
                    this.videoSortable.destroy();
                }
                
                // Don't enable drag and drop on touch devices
                const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                if (isTouchDevice) {
                    return;
                }
                
                const grid = this.elements.videoGrid;
                if (grid.children.length > 0 && !grid.querySelector('.empty-state')) {
                    this.videoSortable = Sortable.create(grid, {
                        animation: 150,
                        ghostClass: 'dragging',
                        chosenClass: 'drag-over',
                        handle: '.video-item',
                        touchStartThreshold: 10,
                        onEnd: (evt) => {
                            if (evt.oldIndex !== evt.newIndex) {
                                // Reorder the collection array
                                const movedItem = this.videoCollection.splice(evt.oldIndex, 1)[0];
                                this.videoCollection.splice(evt.newIndex, 0, movedItem);
                                this.saveVideosToStorage();
                                this.showNotification('Video order updated', 'success');
                            }
                        }
                    });
                }
            }

            async addCurrentPDF() {
                try {
                    let url = '';
                    
                    // Try to read from clipboard
                    if (navigator.clipboard && navigator.clipboard.readText) {
                        try {
                            const clipboardText = await navigator.clipboard.readText();
                            if (clipboardText && this.isValidURL(clipboardText) && clipboardText.toLowerCase().includes('.pdf')) {
                                url = clipboardText;
                            }
                        } catch (e) {
                            console.log('Could not read clipboard:', e);
                        }
                    }
                    
                    // Pre-fill the modal with clipboard URL if available
                    if (url) {
                        this.elements.pdfUrl.value = url;
                    }
                    
                    this.openPdfModal();
                } catch (error) {
                    console.error('Error opening PDF modal:', error);
                    this.openPdfModal();
                }
            }

            initializeLabelColorPicker() {
                const colorOptions = this.elements.colorPicker.querySelectorAll('.color-option');
                colorOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        // Remove selected class from all options
                        colorOptions.forEach(opt => opt.classList.remove('selected'));
                        // Add selected class to clicked option
                        option.classList.add('selected');
                        // Update selected color
                        this.selectedColor = option.dataset.color;
                        // Update preview
                        this.updateLabelPreview();
                    });
                });
            }

            toggleMobileMenu() {
                const dropdown = this.elements.mobileDropdown;
                const isVisible = dropdown.style.display !== 'none';
                dropdown.style.display = isVisible ? 'none' : 'block';
            }

            closeMobileMenu() {
                this.elements.mobileDropdown.style.display = 'none';
            }

            scrollToNotes() {
                // This function is no longer needed but kept for compatibility
                this.openNotesModal();
            }

            openNotesModal() {
                this.renderNotes();
                this.notesModal.show();
            }

            toggleNoteExpansion(noteId) {
                const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
                
                if (noteElement) {
                    const wasExpanded = noteElement.classList.contains('expanded');
                    noteElement.classList.toggle('expanded');
                    
                    // Force a style recalculation
                    const expandable = noteElement.querySelector('.note-expandable');
                    if (expandable) {
                        if (noteElement.classList.contains('expanded')) {
                            expandable.style.display = 'block';
                        } else {
                            expandable.style.display = 'none';
                        }
                    }
                }
            }

            updateLabelPreview() {
                const name = this.elements.labelName.value.trim() || 'Sample Label';
                this.elements.labelPreview.textContent = name;
                this.elements.labelPreview.style.backgroundColor = this.selectedColor;
            }

            updatePdfLabelPreview() {
                const selectedLabelId = this.elements.pdfLabel.value;
                this.updateLabelPreviewElement(selectedLabelId, this.elements.pdfLabelPreview);
            }

            updateVideoLabelPreview() {
                const selectedLabelId = this.elements.videoLabel.value;
                this.updateLabelPreviewElement(selectedLabelId, this.elements.videoLabelPreview);
            }

            updateLabelPreviewElement(labelId, previewElement) {
                if (!labelId) {
                    previewElement.innerHTML = '';
                    return;
                }
                
                const label = this.labelsCollection.find(l => l.id === labelId);
                if (label) {
                    previewElement.innerHTML = `<span class="label-preview" style="background-color: ${label.color};">${this.escapeHtml(label.name)}</span>`;
                }
            }

            openPdfModal() {
                this.elements.pdfForm.reset();
                this.elements.pdfLabelPreview.innerHTML = '';
                this.pdfModal.show();
            }

            openLabelManagementModal() {
                this.renderLabelManagement();
                this.labelManagementModal.show();
            }

            renderLabelManagement() {
                const list = this.elements.labelsManagementList;
                
                if (this.labelsCollection.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-tags"></i>
                            <h5>No Labels Created</h5>
                            <p>Create your first label to organize your collection</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = this.labelsCollection.map(label => {
                        // Count usage
                        const pdfUsage = this.pdfCollection.filter(pdf => pdf.labelId === label.id).length;
                        const videoUsage = this.videoCollection.filter(video => video.labelId === label.id).length;
                        const totalUsage = pdfUsage + videoUsage;
                        
                        return `
                            <div class="label-management-item">
                                <div class="label-info">
                                    <div class="label-color-circle" style="background-color: ${label.color};"></div>
                                    <div class="label-details">
                                        <p class="label-name">${this.escapeHtml(label.name)}</p>
                                        <p class="label-usage">Used in ${totalUsage} item${totalUsage !== 1 ? 's' : ''}</p>
                                    </div>
                                </div>
                                <div class="label-actions">
                                    <button class="label-action-btn" onclick="pdfCompanion.editLabel('${label.id}')" title="Edit label">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="label-action-btn delete" onclick="pdfCompanion.deleteLabel('${label.id}')" title="Delete label">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            editLabel(labelId) {
                const label = this.labelsCollection.find(l => l.id === labelId);
                if (!label) return;
                
                this.currentEditingLabel = labelId;
                this.currentModalType = 'management';
                
                // Fill form with current label data
                this.elements.labelName.value = label.name;
                this.selectedColor = label.color;
                
                // Update UI
                this.elements.labelModalTitle.innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Label';
                this.elements.saveLabelBtnText.textContent = 'Save Changes';
                
                // Set color picker
                const colorOptions = this.elements.colorPicker.querySelectorAll('.color-option');
                colorOptions.forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.color === this.selectedColor);
                });
                
                this.updateLabelPreview();
                this.labelModal.show();
            }

            deleteLabel(labelId) {
                const label = this.labelsCollection.find(l => l.id === labelId);
                if (!label) return;
                
                // Count usage
                const pdfUsage = this.pdfCollection.filter(pdf => pdf.labelId === labelId).length;
                const videoUsage = this.videoCollection.filter(video => video.labelId === labelId).length;
                const totalUsage = pdfUsage + videoUsage;
                
                let confirmMessage = `Delete label "${label.name}"?`;
                if (totalUsage > 0) {
                    confirmMessage += `\n\nThis label is used by ${totalUsage} item${totalUsage !== 1 ? 's' : ''}. The label will be removed from those items.`;
                }
                
                if (confirm(confirmMessage)) {
                    // Remove label from all items
                    this.pdfCollection.forEach(pdf => {
                        if (pdf.labelId === labelId) {
                            pdf.labelId = null;
                        }
                    });
                    
                    this.videoCollection.forEach(video => {
                        if (video.labelId === labelId) {
                            video.labelId = null;
                        }
                    });
                    
                    // Remove label from collection
                    this.labelsCollection = this.labelsCollection.filter(l => l.id !== labelId);
                    
                    // Save all changes
                    this.saveLabelsToStorage();
                    this.saveToStorage();
                    this.saveVideosToStorage();
                    
                    // Update UI
                    this.renderLabelManagement();
                    this.renderGallery();
                    this.renderVideos();
                    this.updateLabelDropdowns();
                    
                    this.showNotification(`Label "${label.name}" deleted`, 'success');
                }
            }

            openLabelModal(modalType) {
                this.currentModalType = modalType;
                this.currentEditingLabel = null;
                this.elements.labelForm.reset();
                this.selectedColor = '#3b82f6';
                
                // Reset UI to creation mode
                this.elements.labelModalTitle.innerHTML = '<i class="bi bi-tag me-2"></i>Create New Label';
                this.elements.saveLabelBtnText.textContent = 'Create Label';
                
                // Reset color picker
                const colorOptions = this.elements.colorPicker.querySelectorAll('.color-option');
                colorOptions.forEach(opt => opt.classList.remove('selected'));
                colorOptions.forEach(opt => {
                    if (opt.dataset.color === this.selectedColor) {
                        opt.classList.add('selected');
                    }
                });
                
                this.updateLabelPreview();
                this.labelModal.show();
            }

            saveLabel() {
                const name = this.elements.labelName.value.trim();
                
                if (!name) {
                    this.showNotification('Please enter a label name', 'error');
                    return;
                }
                
                // Check for duplicates (exclude current label if editing)
                const existingLabel = this.labelsCollection.find(label => 
                    label.name.toLowerCase() === name.toLowerCase() && 
                    label.id !== this.currentEditingLabel
                );
                
                if (existingLabel) {
                    this.showNotification('A label with this name already exists', 'warning');
                    return;
                }
                
                if (this.currentEditingLabel) {
                    // Edit existing label
                    const labelIndex = this.labelsCollection.findIndex(l => l.id === this.currentEditingLabel);
                    if (labelIndex !== -1) {
                        this.labelsCollection[labelIndex] = {
                            ...this.labelsCollection[labelIndex],
                            name,
                            color: this.selectedColor,
                            dateModified: new Date().toISOString()
                        };
                        this.showNotification(`Label "${name}" updated successfully!`, 'success');
                    }
                } else {
                    // Create new label
                    const newLabel = {
                        id: Date.now().toString(),
                        name,
                        color: this.selectedColor,
                        dateAdded: new Date().toISOString()
                    };
                    
                    this.labelsCollection.push(newLabel);
                    this.showNotification(`Label "${name}" created successfully!`, 'success');
                    
                    // Select the new label in the appropriate dropdown
                    if (this.currentModalType === 'pdf') {
                        this.elements.pdfLabel.value = newLabel.id;
                        this.updatePdfLabelPreview();
                    } else if (this.currentModalType === 'video') {
                        this.elements.videoLabel.value = newLabel.id;
                        this.updateVideoLabelPreview();
                    } else if (this.currentModalType === 'change') {
                        this.elements.newLabelSelect.value = newLabel.id;
                        this.updateNewLabelPreview();
                    }
                }
                
                this.saveLabelsToStorage();
                this.updateLabelDropdowns();
                this.renderLabelManagement();
                this.renderGallery();
                this.renderVideos();
                this.labelModal.hide();
            }

            updateLabelDropdowns() {
                const dropdowns = [this.elements.pdfLabel, this.elements.videoLabel, this.elements.newLabelSelect];
                
                dropdowns.forEach(dropdown => {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">No label</option>';
                    
                    this.labelsCollection.forEach(label => {
                        const option = document.createElement('option');
                        option.value = label.id;
                        option.textContent = label.name;
                        option.style.color = label.color;
                        dropdown.appendChild(option);
                    });
                    
                    // Restore selection if it still exists
                    if (currentValue && this.labelsCollection.some(l => l.id === currentValue)) {
                        dropdown.value = currentValue;
                    }
                });
            }

            savePdf() {
                const url = this.elements.pdfUrl.value.trim();
                const labelId = this.elements.pdfLabel.value || null;
                
                if (!url) {
                    this.showNotification('Please provide a PDF URL', 'error');
                    return;
                }

                if (!this.isValidURL(url)) {
                    this.showNotification('Please enter a valid URL', 'error');
                    return;
                }

                if (this.pdfCollection.some(pdf => pdf.url === url)) {
                    this.showNotification('This PDF is already in your collection', 'warning');
                    return;
                }

                this.addPDF(url, labelId);
                this.pdfModal.hide();
            }

            async addPDF(url, labelId = null) {
                url = url.trim();
                
                if (!url) {
                    this.showNotification('Please provide a PDF URL', 'error');
                    return;
                }

                if (!this.isValidURL(url)) {
                    this.showNotification('Please enter a valid URL', 'error');
                    return;
                }

                if (this.pdfCollection.some(pdf => pdf.url === url)) {
                    this.showNotification('This PDF is already in your collection', 'warning');
                    return;
                }

                try {
                    const pdfData = await this.processPDF(url, labelId);
                    this.pdfCollection.push(pdfData);
                    this.saveToStorage();
                    this.renderGallery();
                    this.updateStats();
                    this.updateResourceDropdown();
                    this.showNotification('PDF added to your collection!', 'success');
                } catch (error) {
                    console.error('Error adding PDF:', error);
                    this.showNotification('Failed to process PDF. Please check the URL.', 'error');
                }
            }

            async processPDF(url, labelId = null) {
                const urlParts = url.split('/');
                const filename = urlParts[urlParts.length - 1];
                
                let title = decodeURIComponent(filename)
                    .replace('.pdf', '')
                    .replace(/[-_]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                
                if (!title || title.length < 3) {
                    title = this.extractTitleFromPath(url);
                }
                
                title = title || 'Training Document';

                const pdfData = {
                    id: Date.now().toString(),
                    url: url,
                    title: title,
                    labelId: labelId,
                    dateAdded: new Date().toISOString(),
                    domain: new URL(url).hostname
                };

                return pdfData;
            }

            extractTitleFromPath(url) {
                try {
                    const urlObj = new URL(url);
                    const pathParts = urlObj.pathname.split('/').filter(part => part.length > 0);
                    
                    for (let i = pathParts.length - 1; i >= 0; i--) {
                        const part = pathParts[i];
                        if (!part.includes('.pdf') && part.length > 3) {
                            return decodeURIComponent(part)
                                .replace(/[-_]/g, ' ')
                                .replace(/\s+/g, ' ')
                                .trim();
                        }
                    }
                    
                    return 'Training Document';
                } catch {
                    return 'Training Document';
                }
            }

            renderGallery() {
                const grid = this.elements.pdfGrid;
                
                if (this.pdfCollection.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-file-earmark-plus"></i>
                            <h4>Start Building Your Collection</h4>
                            <p>Add PDFs from Kallidus to create a persistent gallery</p>
                        </div>
                    `;
                } else {
                    grid.innerHTML = this.pdfCollection.map(pdf => {
                        const label = pdf.labelId ? this.labelsCollection.find(l => l.id === pdf.labelId) : null;
                        const labelBar = label ? `<div class="label-bar" style="background-color: ${label.color};">${this.escapeHtml(label.name)}</div>` : '';
                        
                        return `
                            <div class="pdf-item" data-id="${pdf.id}" data-type="pdf">
                                <div class="drag-handle">
                                    <i class="bi bi-grip-horizontal"></i>
                                </div>
                                <div class="pdf-thumbnail" onclick="pdfCompanion.handleThumbnailClick(event, '${pdf.id}', 'pdf')">
                                    <button class="delete-btn" onclick="event.stopPropagation(); pdfCompanion.removePDF('${pdf.id}')" title="Remove from collection">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <div class="pdf-title">${this.escapeHtml(pdf.title)}</div>
                                    <div class="pdf-meta">${this.formatDate(pdf.dateAdded)}</div>
                                    ${labelBar}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                this.initSortable();
            }

            renderVideos() {
                const grid = this.elements.videoGrid;
                
                if (this.videoCollection.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-play-circle-fill"></i>
                            <h4>Add Training Videos</h4>
                            <p>Collect video links for your training resources</p>
                        </div>
                    `;
                } else {
                    grid.innerHTML = this.videoCollection.map(video => {
                        const label = video.labelId ? this.labelsCollection.find(l => l.id === video.labelId) : null;
                        const labelBar = label ? `<div class="label-bar" style="background-color: ${label.color};">${this.escapeHtml(label.name)}</div>` : '';
                        
                        return `
                            <div class="video-item" data-id="${video.id}" data-type="video">
                                <div class="drag-handle">
                                    <i class="bi bi-grip-horizontal"></i>
                                </div>
                                <div class="video-thumbnail" onclick="pdfCompanion.handleThumbnailClick(event, '${video.id}', 'video')">
                                    <button class="delete-btn" onclick="event.stopPropagation(); pdfCompanion.removeVideo('${video.id}')" title="Remove from collection">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <div class="play-icon">
                                        <i class="bi bi-play-circle-fill"></i>
                                    </div>
                                    <div class="pdf-title">${this.escapeHtml(video.title)}</div>
                                    <div class="pdf-meta">${this.formatDate(video.dateAdded)}</div>
                                    ${labelBar}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                this.initVideoSortable();
            }

				handleThumbnailClick(event, resourceId, resourceType) {
					event.preventDefault();
					event.stopPropagation();
					
					const now = Date.now();
					const isTouchDevice = (
						'ontouchstart' in window || 
						navigator.maxTouchPoints > 0 || 
						/iPad|iPhone|iPod/.test(navigator.userAgent) ||
						(navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)
					);
					
					// Store last tap time and resource for this specific thumbnail
					const thumbnailKey = `${resourceType}:${resourceId}`;
					
					if (!this.lastTapData) {
						this.lastTapData = {};
					}
					
					const lastTap = this.lastTapData[thumbnailKey];
					const timeSinceLastTap = lastTap ? now - lastTap.time : Infinity;
					
					// Use consistent timeout for all devices - shorter is better for reliability
					const doubleClickWindow = isTouchDevice ? 400 : 300;
					
					if (timeSinceLastTap < doubleClickWindow) {
						// This is a double tap/click - show summary
						if (this.clickTimeout) {
							clearTimeout(this.clickTimeout);
							this.clickTimeout = null;
						}
						
						// Clear the tap data to prevent triple+ taps from triggering
						delete this.lastTapData[thumbnailKey];
						
						this.showSummary(resourceId, resourceType);
					} else {
						// This is potentially the first tap - wait to see if there's a second one
						this.lastTapData[thumbnailKey] = {
							time: now,
							resourceId: resourceId,
							resourceType: resourceType
						};
						
						// Clear any existing timeout
						if (this.clickTimeout) {
							clearTimeout(this.clickTimeout);
						}
						
						// Set timeout to open resource if no second tap comes
						this.clickTimeout = setTimeout(() => {
							// Only execute if this tap data still exists (hasn't been cleared by double tap)
							if (this.lastTapData[thumbnailKey] && this.lastTapData[thumbnailKey].time === now) {
								delete this.lastTapData[thumbnailKey];
								this.openResource(resourceId, resourceType);
							}
							this.clickTimeout = null;
						}, doubleClickWindow);
					}
				}

            openResource(resourceId, resourceType) {
                if (resourceType === 'pdf') {
                    this.openPDF(resourceId);
                } else if (resourceType === 'video') {
                    this.openVideo(resourceId);
                }
            }

            showSummary(resourceId, resourceType) {
                const resource = resourceType === 'pdf' ? 
                    this.pdfCollection.find(p => p.id === resourceId) :
                    this.videoCollection.find(v => v.id === resourceId);
                
                if (!resource) return;
                
                const summaryKey = `${resourceType}:${resourceId}`;
                const summary = this.summariesCollection[summaryKey];
                
                this.elements.summaryModalTitle.innerHTML = `
                    <i class="bi bi-${resourceType === 'pdf' ? 'file-earmark-pdf' : 'play-circle'} me-2"></i>
                    ${this.escapeHtml(resource.title)}
                `;
                
                if (summary && summary.text.trim()) {
                    // Render markdown to HTML
                    let markdownHtml = marked.parse(summary.text);
                    
                    // If there's an active search, highlight the search terms in the summary
                    if (this.currentSearchTerm) {
                        markdownHtml = this.highlightTextInHtml(markdownHtml, this.currentSearchTerm);
                    }
                    
                    const sanitizedHtml = this.sanitizeHtml(markdownHtml);
                    
                    this.elements.summaryContent.innerHTML = `
                        <div class="summary-content">${sanitizedHtml}</div>
                        <hr>
                        <small class="text-muted">
                            <i class="bi bi-markdown me-1"></i>
                            Last updated: ${this.formatDate(summary.dateModified || summary.dateAdded)}
                        </small>
                    `;
                    
                    // If there's an active search and highlights, scroll to the first highlight
                    setTimeout(() => {
                        const firstHighlight = this.elements.summaryContent.querySelector('.summary-search-highlight.current');
                        if (firstHighlight) {
                            firstHighlight.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center',
                                inline: 'nearest'
                            });
                        }
                    }, 100);
                } else {
                    this.elements.summaryContent.innerHTML = `
                        <p class="text-muted">No summary available for this resource.</p>
                        <p class="text-muted">Right-click, long press, or use the context menu to add a summary with <strong>Markdown</strong> formatting.</p>
                    `;
                }
                
                this.summaryModal.show();
            }

            highlightTextInHtml(html, searchTerm) {
                if (!searchTerm || !searchTerm.trim()) return html;
                
                // Create a temporary div to work with the HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Function to highlight text in text nodes
                const highlightInTextNode = (node, term) => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        const lowerText = text.toLowerCase();
                        const lowerTerm = term.toLowerCase();
                        
                        if (lowerText.includes(lowerTerm)) {
                            // Split the text and wrap matches
                            const parts = [];
                            let lastIndex = 0;
                            let index = lowerText.indexOf(lowerTerm);
                            let isFirst = true;
                            
                            while (index !== -1) {
                                // Add text before match
                                if (index > lastIndex) {
                                    parts.push(document.createTextNode(text.substring(lastIndex, index)));
                                }
                                
                                // Add highlighted match
                                const span = document.createElement('span');
                                span.className = `summary-search-highlight${isFirst ? ' current' : ''}`;
                                span.textContent = text.substring(index, index + term.length);
                                parts.push(span);
                                isFirst = false;
                                
                                lastIndex = index + term.length;
                                index = lowerText.indexOf(lowerTerm, lastIndex);
                            }
                            
                            // Add remaining text
                            if (lastIndex < text.length) {
                                parts.push(document.createTextNode(text.substring(lastIndex)));
                            }
                            
                            // Replace the text node with highlighted content
                            const parent = node.parentNode;
                            parts.forEach(part => parent.insertBefore(part, node));
                            parent.removeChild(node);
                        }
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        // Skip script and style elements
                        if (node.tagName !== 'SCRIPT' && node.tagName !== 'STYLE') {
                            // Process child nodes (use array copy since we're modifying the DOM)
                            Array.from(node.childNodes).forEach(child => {
                                highlightInTextNode(child, term);
                            });
                        }
                    }
                };
                
                highlightInTextNode(tempDiv, searchTerm);
                return tempDiv.innerHTML;
            }

            sanitizeHtml(html) {
                // Basic HTML sanitization - remove script tags and dangerous attributes
                const div = document.createElement('div');
                div.innerHTML = html;
                
                // Remove script tags
                const scripts = div.querySelectorAll('script');
                scripts.forEach(script => script.remove());
                
                // Remove dangerous attributes
                const dangerousAttrs = ['onclick', 'onload', 'onerror', 'onmouseover', 'onfocus', 'onblur'];
                const allElements = div.querySelectorAll('*');
                allElements.forEach(el => {
                    dangerousAttrs.forEach(attr => {
                        if (el.hasAttribute(attr)) {
                            el.removeAttribute(attr);
                        }
                    });
                    
                    // Ensure links open in new tab and are safe
                    if (el.tagName === 'A') {
                        el.setAttribute('target', '_blank');
                        el.setAttribute('rel', 'noopener noreferrer');
                    }
                });
                
                return div.innerHTML;
            }

            handleContextMenu(event) {
                // Find the closest thumbnail element
                const thumbnail = event.target.closest('.pdf-thumbnail, .video-thumbnail');
                if (!thumbnail) {
                    this.hideContextMenu();
                    return;
                }
                
                event.preventDefault();
                
                const item = thumbnail.closest('.pdf-item, .video-item');
                if (!item) return;
                
                const resourceId = item.dataset.id;
                const resourceType = item.dataset.type;
                
                if (!resourceId || !resourceType) return;
                
                // Store current resource for context menu actions
                this.currentSummaryResource = { id: resourceId, type: resourceType };
                
                // Position and show context menu
                const contextMenu = this.elements.contextMenu;
                contextMenu.style.display = 'block';
                
                // Calculate position
                let x, y;
                if (event.touches && event.touches.length > 0) {
                    // Touch event - use first touch
                    x = event.touches[0].clientX;
                    y = event.touches[0].clientY;
                } else if (event.changedTouches && event.changedTouches.length > 0) {
                    // Touch end event - use changedTouches
                    x = event.changedTouches[0].clientX;
                    y = event.changedTouches[0].clientY;
                } else {
                    // Mouse event
                    x = event.clientX;
                    y = event.clientY;
                }
                
                // Get menu dimensions
                const menuRect = contextMenu.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // Adjust position to keep menu on screen
                if (x + menuRect.width > viewportWidth) {
                    x = viewportWidth - menuRect.width - 10;
                }
                if (y + menuRect.height > viewportHeight) {
                    y = viewportHeight - menuRect.height - 10;
                }
                
                // Ensure minimum distance from edges
                x = Math.max(10, x);
                y = Math.max(10, y);
                
                contextMenu.style.left = `${x}px`;
                contextMenu.style.top = `${y}px`;
            }
			
			handleOpenPdf() {
				if (!this.currentSummaryResource) return;
				
				const { id, type } = this.currentSummaryResource;
				this.hideContextMenu();
				
				if (type === 'pdf') {
					this.openPDF(id);
				} else if (type === 'video') {
					this.openVideo(id);
				}
			}

			handleOpenSummary() {
				if (!this.currentSummaryResource) return;
				
				const { id, type } = this.currentSummaryResource;
				this.hideContextMenu();
				this.showSummary(id, type);
			}

            hideContextMenu() {
                this.elements.contextMenu.style.display = 'none';
                // Don't clear currentSummaryResource here - it's needed for the edit modal
            }

            openEditSummaryModal() {
                if (!this.currentSummaryResource) return;
                
                const { id, type } = this.currentSummaryResource;
                const resource = type === 'pdf' ? 
                    this.pdfCollection.find(p => p.id === id) :
                    this.videoCollection.find(v => v.id === id);
                
                if (!resource) return;
                
                const summaryKey = `${type}:${id}`;
                const summary = this.summariesCollection[summaryKey];
                
                this.elements.resourceTitle.value = resource.title;
                this.elements.summaryText.value = summary ? summary.text : '';
                
                this.hideContextMenu();
                this.editSummaryModal.show();
            }

            openChangeLabelModal() {
                if (!this.currentSummaryResource) return;
                
                const { id, type } = this.currentSummaryResource;
                const resource = type === 'pdf' ? 
                    this.pdfCollection.find(p => p.id === id) :
                    this.videoCollection.find(v => v.id === id);
                
                if (!resource) return;
                
                // Set resource title
                this.elements.changeResourceTitle.value = resource.title;
                
                // Show current label
                const currentLabel = resource.labelId ? this.labelsCollection.find(l => l.id === resource.labelId) : null;
                if (currentLabel) {
                    this.elements.currentLabelDisplay.innerHTML = `
                        <span class="label-preview" style="background-color: ${currentLabel.color};">
                            ${this.escapeHtml(currentLabel.name)}
                        </span>
                    `;
                } else {
                    this.elements.currentLabelDisplay.innerHTML = '<span class="text-muted">No label</span>';
                }
                
                // Reset new label selection
                this.elements.newLabelSelect.value = resource.labelId || '';
                this.updateNewLabelPreview();
                
                this.hideContextMenu();
                this.changeLabelModal.show();
            }

            updateNewLabelPreview() {
                const selectedLabelId = this.elements.newLabelSelect.value;
                this.updateLabelPreviewElement(selectedLabelId, this.elements.newLabelPreview);
            }

            saveNewLabel() {
                if (!this.currentSummaryResource) {
                    this.showNotification('Error: No resource selected', 'error');
                    return;
                }
                
                const { id, type } = this.currentSummaryResource;
                const newLabelId = this.elements.newLabelSelect.value || null;
                
                // Find the resource and update its label
                if (type === 'pdf') {
                    const pdfIndex = this.pdfCollection.findIndex(p => p.id === id);
                    if (pdfIndex !== -1) {
                        this.pdfCollection[pdfIndex].labelId = newLabelId;
                        this.saveToStorage();
                        this.renderGallery();
                    }
                } else if (type === 'video') {
                    const videoIndex = this.videoCollection.findIndex(v => v.id === id);
                    if (videoIndex !== -1) {
                        this.videoCollection[videoIndex].labelId = newLabelId;
                        this.saveVideosToStorage();
                        this.renderVideos();
                    }
                }
                
                const newLabel = newLabelId ? this.labelsCollection.find(l => l.id === newLabelId) : null;
                const labelName = newLabel ? newLabel.name : 'No label';
                
                this.showNotification(`Label changed to "${labelName}"`, 'success');
                this.changeLabelModal.hide();
                this.currentSummaryResource = null;
            }

            saveSummary() {
                if (!this.currentSummaryResource) {
                    this.showNotification('Error: No resource selected for summary', 'error');
                    return;
                }
                
                const { id, type } = this.currentSummaryResource;
                const summaryText = this.elements.summaryText.value.trim();
                const summaryKey = `${type}:${id}`;
                
                if (summaryText) {
                    // Save or update summary
                    this.summariesCollection[summaryKey] = {
                        text: summaryText,
                        dateAdded: this.summariesCollection[summaryKey]?.dateAdded || new Date().toISOString(),
                        dateModified: new Date().toISOString()
                    };
                    this.showNotification('Summary saved successfully!', 'success');
                } else {
                    // Remove summary if empty
                    delete this.summariesCollection[summaryKey];
                    this.showNotification('Summary removed', 'success');
                }
                
                this.saveSummariesToStorage();
                this.editSummaryModal.hide();
                this.currentSummaryResource = null;
            }

            loadSummariesFromStorage() {
                try {
                    const stored = localStorage.getItem('pdfCompanionSummaries');
                    return stored ? JSON.parse(stored) : {};
                } catch (error) {
                    console.error('Failed to load summaries from localStorage:', error);
                    return {};
                }
            }

            saveSummariesToStorage() {
                try {
                    localStorage.setItem('pdfCompanionSummaries', JSON.stringify(this.summariesCollection));
                    this.updateStorageIndicator();
                } catch (error) {
                    console.error('Failed to save summaries to localStorage:', error);
                    this.showNotification('Warning: Could not save summaries to local storage', 'error');
                }
            }

            openVideoModal() {
                this.elements.videoForm.reset();
                this.elements.videoLabelPreview.innerHTML = '';
                this.videoModal.show();
            }

            saveVideo() {
                const title = this.elements.videoTitle.value.trim();
                const url = this.elements.videoUrl.value.trim();
                const labelId = this.elements.videoLabel.value || null;
                
                if (!title || !url) {
                    this.showNotification('Please fill in both title and URL', 'error');
                    return;
                }
                
                if (!this.isValidURL(url)) {
                    this.showNotification('Please enter a valid URL', 'error');
                    return;
                }
                
                if (this.videoCollection.some(video => video.url === url)) {
                    this.showNotification('This video is already in your collection', 'warning');
                    return;
                }
                
                const newVideo = {
                    id: Date.now().toString(),
                    title,
                    url,
                    labelId,
                    dateAdded: new Date().toISOString(),
                    domain: new URL(url).hostname
                };
                
                this.videoCollection.push(newVideo);
                this.saveVideosToStorage();
                this.renderVideos();
                this.updateStats();
                this.updateResourceDropdown();
                this.videoModal.hide();
                this.showNotification('Video added to your collection!', 'success');
            }

            openVideo(id) {
                const video = this.videoCollection.find(v => v.id === id);
                if (!video) return;
                window.open(video.url, '_blank');
            }

            removeVideo(id) {
                const video = this.videoCollection.find(v => v.id === id);
                if (!video) return;
                
                if (confirm(`Remove "${video.title}" from your collection?`)) {
                    this.videoCollection = this.videoCollection.filter(v => v.id !== id);
                    // Also remove video links from notes
                    this.notesCollection.forEach(note => {
                        if (note.pdfId === id) {
                            note.pdfId = null;
                        }
                    });
                    // Remove summary if exists
                    const summaryKey = `video:${id}`;
                    delete this.summariesCollection[summaryKey];
                    
                    this.saveVideosToStorage();
                    this.saveNotesToStorage();
                    this.saveVideosToStorage();
                    this.saveSummariesToStorage();
                    this.renderVideos();
                    this.updateStats();
                    this.updateResourceDropdown();
                    this.showNotification('Video removed from collection', 'success');
                }
            }

            renderNotes() {
                const notesList = this.elements.notesListModal;
                
                // Update notes count
                this.elements.notesCount.textContent = this.notesCollection.length;
                
                if (this.notesCollection.length === 0) {
                    notesList.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-journal-plus"></i>
                            <h5>No Notes Yet</h5>
                            <p>Start taking notes about your training</p>
                        </div>
                    `;
                } else {
                    notesList.innerHTML = this.notesCollection.map(note => {
                        let linkedResource = null;
                        let resourceIcon = '';
                        let linkedResourceHtml = '';
                        
                        if (note.pdfId) {
                            if (note.pdfId.startsWith('pdf:')) {
                                const pdfId = note.pdfId.substring(4);
                                linkedResource = this.pdfCollection.find(pdf => pdf.id === pdfId);
                                resourceIcon = 'bi-file-earmark-pdf';
                            } else if (note.pdfId.startsWith('video:')) {
                                const videoId = note.pdfId.substring(6);
                                linkedResource = this.videoCollection.find(video => video.id === videoId);
                                resourceIcon = 'bi-play-circle';
                            } else {
                                // Legacy format - assume PDF
                                linkedResource = this.pdfCollection.find(pdf => pdf.id === note.pdfId);
                                resourceIcon = 'bi-file-earmark-pdf';
                            }
                            
                            if (linkedResource) {
                                linkedResourceHtml = `
                                    <div class="note-pdf-link" onclick="event.stopPropagation(); pdfCompanion.openLinkedResource('${note.pdfId}')">
                                        <i class="bi ${resourceIcon} me-1"></i>
                                        ${this.escapeHtml(linkedResource.title)}
                                    </div>
                                `;
                            }
                        }
                        
                        return `
                            <div class="note-item" data-note-id="${note.id}">
                                <div class="note-header" onclick="pdfCompanion.toggleNoteExpansion('${note.id}')">
                                    <h6 class="note-title">
                                        <i class="bi bi-chevron-down note-expand-icon me-2"></i>
                                        ${this.escapeHtml(note.title)}
                                    </h6>
                                    <div class="note-actions">
                                        <button class="note-btn" onclick="event.stopPropagation(); pdfCompanion.editNote('${note.id}')" title="Edit note">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="note-btn" onclick="event.stopPropagation(); pdfCompanion.removeNote('${note.id}')" title="Delete note">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="note-expandable">
                                    <div class="note-content">${this.escapeHtml(note.content)}</div>
                                    ${linkedResourceHtml}
                                    <div class="note-date">${this.formatDate(note.dateAdded)}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Ensure all notes start collapsed
                    setTimeout(() => {
                        const allNotes = document.querySelectorAll('.note-item');
                        allNotes.forEach(note => {
                            note.classList.remove('expanded');
                            const expandable = note.querySelector('.note-expandable');
                            if (expandable) {
                                expandable.style.display = 'none';
                            }
                        });
                    }, 100);
                }
            }

            openLinkedResource(resourceId) {
                if (resourceId.startsWith('pdf:')) {
                    const pdfId = resourceId.substring(4);
                    this.openPDF(pdfId);
                } else if (resourceId.startsWith('video:')) {
                    const videoId = resourceId.substring(6);
                    this.openVideo(videoId);
                } else {
                    // Legacy format - assume PDF
                    this.openPDF(resourceId);
                }
            }

            updateResourceDropdown() {
                const dropdown = this.elements.notePdfLink;
                dropdown.innerHTML = '<option value="">No resource selected</option>';
                
                // Add PDFs
                if (this.pdfCollection.length > 0) {
                    const pdfGroup = document.createElement('optgroup');
                    pdfGroup.label = 'PDFs';
                    this.pdfCollection.forEach(pdf => {
                        const option = document.createElement('option');
                        option.value = `pdf:${pdf.id}`;
                        option.textContent = `📄 ${pdf.title}`;
                        pdfGroup.appendChild(option);
                    });
                    dropdown.appendChild(pdfGroup);
                }
                
                // Add Videos
                if (this.videoCollection.length > 0) {
                    const videoGroup = document.createElement('optgroup');
                    videoGroup.label = 'Videos';
                    this.videoCollection.forEach(video => {
                        const option = document.createElement('option');
                        option.value = `video:${video.id}`;
                        option.textContent = `🎥 ${video.title}`;
                        videoGroup.appendChild(option);
                    });
                    dropdown.appendChild(videoGroup);
                }
            }

            openNoteModal(noteId = null) {
                // Check if notes modal is currently open (especially important for mobile)
                const notesModalOpen = this.elements.notesModal.classList.contains('show');
                
                if (notesModalOpen) {
                    // On mobile, temporarily hide notes modal to avoid stacking issues
                    this.shouldRestoreNotesModal = true;
                    this.notesModal.hide();
                    
                    // Small delay to ensure clean transition
                    setTimeout(() => {
                        this.showNoteModal(noteId);
                    }, 150);
                } else {
                    this.showNoteModal(noteId);
                }
            }

            showNoteModal(noteId = null) {
                this.currentEditingNote = noteId;
                const note = noteId ? this.notesCollection.find(n => n.id === noteId) : null;
                
                if (note) {
                    this.elements.noteModalTitle.textContent = 'Edit Note';
                    this.elements.noteTitle.value = note.title;
                    this.elements.noteContent.value = note.content;
                    this.elements.notePdfLink.value = note.pdfId || '';
                } else {
                    this.elements.noteModalTitle.textContent = 'Add New Note';
                    this.elements.noteForm.reset();
                }
                
                this.noteModal.show();
            }

            editNote(noteId) {
                this.openNoteModal(noteId);
            }

            saveNote() {
                const title = this.elements.noteTitle.value.trim();
                const content = this.elements.noteContent.value.trim();
                const pdfId = this.elements.notePdfLink.value || null;
                
                if (!title || !content) {
                    this.showNotification('Please fill in title and content', 'error');
                    return;
                }
                
                if (this.currentEditingNote) {
                    // Edit existing note
                    const noteIndex = this.notesCollection.findIndex(n => n.id === this.currentEditingNote);
                    if (noteIndex !== -1) {
                        this.notesCollection[noteIndex] = {
                            ...this.notesCollection[noteIndex],
                            title,
                            content,
                            pdfId,
                            dateModified: new Date().toISOString()
                        };
                        this.showNotification('Note updated successfully!', 'success');
                    }
                } else {
                    // Add new note
                    const newNote = {
                        id: Date.now().toString(),
                        title,
                        content,
                        pdfId,
                        dateAdded: new Date().toISOString()
                    };
                    this.notesCollection.unshift(newNote);
                    this.showNotification('Note added successfully!', 'success');
                }
                
                this.saveNotesToStorage();
                // Re-render notes if modal will be restored
                if (this.shouldRestoreNotesModal) {
                    // Don't render immediately, will render when notes modal reopens
                } else if (this.elements.notesModal.classList.contains('show')) {
                    this.renderNotes();
                }
                this.noteModal.hide();
                this.currentEditingNote = null;
            }

            removeNote(noteId) {
                const note = this.notesCollection.find(n => n.id === noteId);
                if (!note) return;
                
                if (confirm(`Delete note "${note.title}"?`)) {
                    this.notesCollection = this.notesCollection.filter(n => n.id !== noteId);
                    this.saveNotesToStorage();
                    // Re-render notes if modal is open (will be handled by modal event listeners)
                    if (this.elements.notesModal.classList.contains('show')) {
                        this.renderNotes();
                    }
                    this.showNotification('Note deleted', 'success');
                }
            }

            searchNotes(query) {
                const items = document.querySelectorAll('.note-item');
                const searchTerm = query.toLowerCase();

                items.forEach(item => {
                    const title = item.querySelector('.note-title').textContent.toLowerCase();
                    const content = item.querySelector('.note-content').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || content.includes(searchTerm)) {
                        item.style.display = 'block';
                        // If search matches content, expand the note to show it
                        if (content.includes(searchTerm) && !title.includes(searchTerm)) {
                            item.classList.add('expanded');
                        }
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // If search is cleared, collapse all notes
                if (!query.trim()) {
                    items.forEach(item => {
                        item.classList.remove('expanded');
                    });
                }
            }

            openPDF(id) {
                const pdf = this.pdfCollection.find(p => p.id === id);
                if (!pdf) return;
                window.open(pdf.url, '_blank');
            }

            removePDF(id) {
                const pdf = this.pdfCollection.find(p => p.id === id);
                if (!pdf) return;
                
                if (confirm(`Remove "${pdf.title}" from your collection?`)) {
                    this.pdfCollection = this.pdfCollection.filter(pdf => pdf.id !== id);
                    // Also remove PDF links from notes
                    this.notesCollection.forEach(note => {
                        if (note.pdfId === id || note.pdfId === `pdf:${id}`) {
                            note.pdfId = null;
                        }
                    });
                    // Remove summary if exists
                    const summaryKey = `pdf:${id}`;
                    delete this.summariesCollection[summaryKey];
                    
                    this.saveToStorage();
                    this.saveNotesToStorage();
                    this.saveSummariesToStorage();
                    this.renderGallery();
                    this.updateStats();
                    this.updateResourceDropdown();
                    this.showNotification('PDF removed from collection', 'success');
                }
            }

            updateStats() {
                this.elements.pdfCount.textContent = this.pdfCollection.length;
                this.elements.videoCount.textContent = this.videoCollection.length;
                
                if (this.pdfCollection.length > 0) {
                    const lastAdded = new Date(this.pdfCollection[this.pdfCollection.length - 1].dateAdded);
                    this.elements.lastAdded.textContent = this.formatDate(lastAdded.toISOString());
                } else {
                    this.elements.lastAdded.textContent = 'None';
                }
                
                if (this.videoCollection.length > 0) {
                    const lastVideoAdded = new Date(this.videoCollection[this.videoCollection.length - 1].dateAdded);
                    this.elements.lastVideoAdded.textContent = this.formatDate(lastVideoAdded.toISOString());
                } else {
                    this.elements.lastVideoAdded.textContent = 'None';
                }
            }

            async checkAndLoadCentralData() {
                try {
                    // Try to fetch the central data file
                    const response = await fetch('./bookmarkerdata.json');
                    if (!response.ok) {
                        console.log('Central data file not found, using existing local storage data');
                        return;
                    }
                    
                    const centralData = await response.json();
                    const centralVersion = centralData.version;
                    
                    if (!centralVersion) {
                        console.log('Central data file has no version, skipping auto-import');
                        return;
                    }
                    
                    // Check if we should import from central file
                    const shouldImport = this.shouldImportCentralData(centralVersion);
                    
                    if (shouldImport) {
                        console.log(`Importing central data version ${centralVersion}`);
                        await this.importCentralData(centralData);
                        
                        // Store the version in localStorage to track updates
                        localStorage.setItem('pdfCompanionVersion', centralVersion);
                        
                        this.showNotification(`Updated to data version ${centralVersion}`, 'success');
                    }
                } catch (error) {
                    console.log('Could not load central data file:', error);
                    // This is not an error - the file might not exist in development
                }
            }

            shouldImportCentralData(centralVersion) {
                // Check if there's any data in localStorage
                const hasCollectionData = localStorage.getItem('pdfCompanionCollection');
                const hasVideoData = localStorage.getItem('pdfCompanionVideos');
                const hasLabelsData = localStorage.getItem('pdfCompanionLabels');
                const hasSummariesData = localStorage.getItem('pdfCompanionSummaries');
                
                // Check stored version
                const storedVersion = localStorage.getItem('pdfCompanionVersion');
                
                // Import if no data exists, no version stored, or central version is newer
                if (!hasCollectionData && !hasVideoData && !hasLabelsData && !hasSummariesData) {
                    return true; // No data exists
                }
                
                if (!storedVersion) {
                    return true; // No version tracking yet
                }
                
                // Compare versions (assuming semantic versioning or numeric)
                return this.isVersionNewer(centralVersion, storedVersion);
            }

            isVersionNewer(newVersion, currentVersion) {
                // Simple version comparison - can be enhanced for semantic versioning
                const newNum = parseFloat(newVersion);
                const currentNum = parseFloat(currentVersion);
                
                return newNum > currentNum;
            }

            async importCentralData(centralData) {
                try {
                    // Import PDFs, videos, labels, and summaries from central file
                    this.pdfCollection = centralData.collection || centralData.pdfs || [];
                    this.videoCollection = centralData.videos || [];
                    this.labelsCollection = centralData.labels || [];
                    this.summariesCollection = centralData.summaries || {};
                    
                    // Save to localStorage (notes are preserved separately)
                    this.saveToStorage();
                    this.saveVideosToStorage();
                    this.saveLabelsToStorage();
                    this.saveSummariesToStorage();
                    
                    console.log('Central data imported successfully');
                } catch (error) {
                    console.error('Error importing central data:', error);
                    this.showNotification('Error importing central data', 'error');
                }
            }

            handleAdminClick(event) {
                event.preventDefault();
                
                this.adminClickCount++;
                
                // Clear any existing timer
                if (this.adminClickTimer) {
                    clearTimeout(this.adminClickTimer);
                }
                
                // Set timer to reset click count after 2 seconds
                this.adminClickTimer = setTimeout(() => {
                    this.adminClickCount = 0;
                }, 2000);
                
                // Check if we've reached 3 clicks
                if (this.adminClickCount >= 3) {
                    this.adminClickCount = 0;
                    clearTimeout(this.adminClickTimer);
                    this.adminClickTimer = null;
                    
                    // Show admin dropdown menu
                    this.showAdminDropdown();
                }
            }

            showAdminDropdown() {
                this.elements.adminDropdown.style.display = 'block';
                // Add a slight delay and animation effect
                setTimeout(() => {
                    this.elements.adminDropdown.style.opacity = '1';
                    this.elements.adminDropdown.style.transform = 'translateX(-50%) translateY(0)';
                }, 10);
            }

            hideAdminDropdown() {
                this.elements.adminDropdown.style.display = 'none';
                this.elements.adminDropdown.style.opacity = '0';
                this.elements.adminDropdown.style.transform = 'translateX(-50%) translateY(-10px)';
            }

            exportCentralData() {
                try {
                    // Get current version and increment it
                    const currentVersion = localStorage.getItem('pdfCompanionVersion') || '1.0';
                    const newVersion = (parseFloat(currentVersion) + 0.1).toFixed(1);
                    
                    // Create central data structure (excluding notes)
                    const centralData = {
                        version: newVersion,
                        exportDate: new Date().toISOString(),
                        totalPdfs: this.pdfCollection.length,
                        totalVideos: this.videoCollection.length,
                        totalLabels: this.labelsCollection.length,
                        totalSummaries: Object.keys(this.summariesCollection).length,
                        collection: this.pdfCollection,
                        videos: this.videoCollection,
                        labels: this.labelsCollection,
                        summaries: this.summariesCollection
                    };

                    const dataStr = JSON.stringify(centralData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = 'bookmarkerdata.json';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    URL.revokeObjectURL(link.href);
                    
                    // Update stored version
                    localStorage.setItem('pdfCompanionVersion', newVersion);
                    
                    const summariesCount = Object.keys(this.summariesCollection).length;
                    this.showNotification(`🔧 Admin: Exported central data v${newVersion} (${this.pdfCollection.length} PDFs, ${this.videoCollection.length} videos, ${this.labelsCollection.length} labels, ${summariesCount} summaries)`, 'success');
                } catch (error) {
                    console.error('Admin export error:', error);
                    this.showNotification('🔧 Admin: Failed to export central data', 'error');
                }
            }

            saveNotesToFile() {
                if (this.notesCollection.length === 0) {
                    this.showNotification('No notes to save', 'warning');
                    return;
                }

                try {
                    const exportData = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        totalNotes: this.notesCollection.length,
                        notes: this.notesCollection
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `my-notes-${new Date().toISOString().split('T')[0]}.json`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    URL.revokeObjectURL(link.href);
                    
                    this.showNotification(`Saved ${this.notesCollection.length} notes to file!`, 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('Failed to save notes', 'error');
                }
            }

            triggerNotesImport() {
                this.elements.notesImportFile.click();
            }

            async importNotesFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Reset the file input
                event.target.value = '';

                if (file.type !== 'application/json') {
                    this.showNotification('Please select a valid JSON file', 'error');
                    return;
                }

                try {
                    const fileText = await this.readFileAsText(file);
                    const importData = JSON.parse(fileText);
                    
                    // Validate the imported notes data
                    if (!this.validateNotesImportData(importData)) {
                        this.showNotification('Invalid notes file format. Please select a valid notes file.', 'error');
                        return;
                    }

                    // Confirm import if there are existing notes
                    if (this.notesCollection.length > 0) {
                        const confirmed = confirm(
                            `This will replace your current ${this.notesCollection.length} notes. Import ${(importData.notes || []).length} notes from file?`
                        );
                        if (!confirmed) return;
                    }

                    // Import the notes
                    this.notesCollection = importData.notes || [];
                    this.saveNotesToStorage();
                    
                    // Re-render notes if modal is open
                    if (this.elements.notesModal.classList.contains('show')) {
                        this.renderNotes();
                    }
                    
                    this.updateResourceDropdown();
                    this.updateStorageIndicator();
                    
                    this.showNotification(`Successfully imported ${this.notesCollection.length} notes!`, 'success');
                } catch (error) {
                    console.error('Notes import error:', error);
                    this.showNotification('Failed to import notes. Please check the file format.', 'error');
                }
            }

            validateNotesImportData(data) {
                // Check if it has the required structure for notes
                if (!data || typeof data !== 'object') return false;
                
                // Check if notes array exists
                if (!Array.isArray(data.notes)) return false;
                
                // Validate each note item
                for (const note of data.notes) {
                    if (!note.id || !note.title || !note.content || !note.dateAdded) {
                        return false;
                    }
                }
                
                return true;
            }

            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file);
                });
            }

            saveToStorage() {
                try {
                    localStorage.setItem('pdfCompanionCollection', JSON.stringify(this.pdfCollection));
                    this.updateStorageIndicator();
                } catch (error) {
                    console.error('Failed to save to localStorage:', error);
                    this.showNotification('Warning: Could not save to local storage', 'error');
                }
            }

            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('pdfCompanionCollection');
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Failed to load from localStorage:', error);
                    return [];
                }
            }

            saveNotesToStorage() {
                try {
                    localStorage.setItem('pdfCompanionNotes', JSON.stringify(this.notesCollection));
                    this.updateStorageIndicator();
                } catch (error) {
                    console.error('Failed to save notes to localStorage:', error);
                    this.showNotification('Warning: Could not save notes to local storage', 'error');
                }
            }

            loadNotesFromStorage() {
                try {
                    const stored = localStorage.getItem('pdfCompanionNotes');
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Failed to load notes from localStorage:', error);
                    return [];
                }
            }

            saveVideosToStorage() {
                try {
                    localStorage.setItem('pdfCompanionVideos', JSON.stringify(this.videoCollection));
                    this.updateStorageIndicator();
                } catch (error) {
                    console.error('Failed to save videos to localStorage:', error);
                    this.showNotification('Warning: Could not save videos to local storage', 'error');
                }
            }

            loadVideosFromStorage() {
                try {
                    const stored = localStorage.getItem('pdfCompanionVideos');
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Failed to load videos from localStorage:', error);
                    return [];
                }
            }

            saveLabelsToStorage() {
                try {
                    localStorage.setItem('pdfCompanionLabels', JSON.stringify(this.labelsCollection));
                    this.updateStorageIndicator();
                } catch (error) {
                    console.error('Failed to save labels to localStorage:', error);
                    this.showNotification('Warning: Could not save labels to local storage', 'error');
                }
            }

            loadLabelsFromStorage() {
                try {
                    const stored = localStorage.getItem('pdfCompanionLabels');
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Failed to load labels from localStorage:', error);
                    return [];
                }
            }

            showNotification(message, type) {
                const notification = this.elements.notification;
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 4000);
            }

            isValidURL(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }

            calculateStorageUsage() {
                let totalBytes = 0;
                
                // Calculate size of all app-related localStorage items
                const appKeys = [
                    'pdfCompanionCollection',      // PDF collection
                    'pdfCompanionVideos',          // Video collection 
                    'pdfCompanionNotes',           // User notes (separate from central data)
                    'pdfCompanionLabels',          // Labels collection
                    'pdfCompanionSummaries',       // Summaries collection
                    'pdfCompanionVersion'          // Version tracking for central data
                ];
                
                appKeys.forEach(key => {
                    const item = localStorage.getItem(key);
                    if (item) {
                        // Calculate size in bytes (each character is roughly 1 byte in UTF-8)
                        totalBytes += new Blob([item]).size;
                    }
                });
                
                return totalBytes;
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0 KB';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                const value = bytes / Math.pow(k, i);
                const formattedValue = i === 0 ? value : value.toFixed(1);
                
                return `${formattedValue} ${sizes[i]}`;
            }

            updateStorageIndicator() {
                const usedBytes = this.calculateStorageUsage();
                const estimatedLimitBytes = 10 * 1024 * 1024; // 10MB estimate
                const percentage = Math.round((usedBytes / estimatedLimitBytes) * 100);
                
                // Update display
                this.elements.storageUsed.textContent = this.formatBytes(usedBytes);
                this.elements.storagePercent.textContent = `${percentage}%`;
                
                // Update total items count
                const totalItems = this.pdfCollection.length + 
                                 this.videoCollection.length + 
                                 this.notesCollection.length + 
                                 Object.keys(this.summariesCollection).length;
                this.elements.totalItems.textContent = totalItems;
                
                // Update indicator styling based on usage
                const indicator = this.elements.storageIndicator;
                indicator.classList.remove('warning', 'danger');
                
                if (percentage >= 85) {
                    indicator.classList.add('danger');
                } else if (percentage >= 60) {
                    indicator.classList.add('warning');
                }
                
                // Update storage limit display based on actual browser
                const limitText = this.getStorageLimitText();
                this.elements.storageLimit.textContent = limitText;
            }

            getStorageLimitText() {
                // Different browsers have different localStorage limits
                const userAgent = navigator.userAgent.toLowerCase();
                
                if (userAgent.includes('firefox')) {
                    return '~10 MB';
                } else if (userAgent.includes('safari') && !userAgent.includes('chrome')) {
                    return '~5 MB';
                } else if (userAgent.includes('chrome') || userAgent.includes('edge')) {
                    return '~10 MB';
                } else {
                    return '~5-10 MB';
                }
            }

            exportCollection() {
                if (this.pdfCollection.length === 0 && this.videoCollection.length === 0 && this.notesCollection.length === 0) {
                    this.showNotification('No data to export', 'warning');
                    return;
                }

                try {
                    const exportData = {
                        version: '5.0',
                        exportDate: new Date().toISOString(),
                        totalPdfs: this.pdfCollection.length,
                        totalVideos: this.videoCollection.length,
                        totalNotes: this.notesCollection.length,
                        totalLabels: this.labelsCollection.length,
                        totalSummaries: Object.keys(this.summariesCollection).length,
                        collection: this.pdfCollection,
                        videos: this.videoCollection,
                        notes: this.notesCollection,
                        labels: this.labelsCollection,
                        summaries: this.summariesCollection
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `pdf-collection-${new Date().toISOString().split('T')[0]}.json`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    URL.revokeObjectURL(link.href);
                    
                    const summariesCount = Object.keys(this.summariesCollection).length;
                    this.showNotification(`Exported ${this.pdfCollection.length} PDFs, ${this.videoCollection.length} videos, ${this.notesCollection.length} notes, ${this.labelsCollection.length} labels, and ${summariesCount} summaries!`, 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('Failed to export collection', 'error');
                }
            }

            triggerImport() {
                this.elements.importFile.click();
            }

            async importCollection(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Reset the file input
                event.target.value = '';

                if (file.type !== 'application/json') {
                    this.showNotification('Please select a valid JSON file', 'error');
                    return;
                }

                try {
                    const fileText = await this.readFileAsText(file);
                    const importData = JSON.parse(fileText);
                    
                    // Validate the imported data
                    if (!this.validateImportData(importData)) {
                        this.showNotification('Invalid file format. Please select a valid PDF collection file.', 'error');
                        return;
                    }

                    // Confirm import if there is existing data
                    const hasExistingData = this.pdfCollection.length > 0 || this.videoCollection.length > 0 || this.notesCollection.length > 0 || this.labelsCollection.length > 0 || Object.keys(this.summariesCollection).length > 0;
                    if (hasExistingData) {
                        const totalItems = this.pdfCollection.length + this.videoCollection.length + this.notesCollection.length + this.labelsCollection.length + Object.keys(this.summariesCollection).length;
                        const importItems = (importData.collection || []).length + (importData.videos || []).length + (importData.notes || []).length + (importData.labels || []).length + Object.keys(importData.summaries || {}).length;
                        const confirmed = confirm(
                            `This will replace your current collection of ${totalItems} items. Import ${importItems} items from file?`
                        );
                        if (!confirmed) return;
                    }

                    // Import the collection
                    this.pdfCollection = importData.collection || [];
                    this.videoCollection = importData.videos || [];
                    this.notesCollection = importData.notes || [];
                    this.labelsCollection = importData.labels || [];
                    this.summariesCollection = importData.summaries || {};
                    this.saveToStorage();
                    this.saveVideosToStorage();
                    this.saveNotesToStorage();
                    this.saveLabelsToStorage();
                    this.saveSummariesToStorage();
                    this.renderGallery();
                    this.renderVideos();
                    this.renderNotes();
                    this.updateStats();
                    this.updateResourceDropdown();
                    this.updateLabelDropdowns();
                    this.updateStorageIndicator();
                    
                    const summariesCount = Object.keys(this.summariesCollection).length;
                    this.showNotification(`Successfully imported ${this.pdfCollection.length} PDFs, ${this.videoCollection.length} videos, ${this.notesCollection.length} notes, ${this.labelsCollection.length} labels, and ${summariesCount} summaries!`, 'success');
                } catch (error) {
                    console.error('Import error:', error);
                    this.showNotification('Failed to import collection. Please check the file format.', 'error');
                }
            }

            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file);
                });
            }

            validateImportData(data) {
                // Check if it has the required structure
                if (!data || typeof data !== 'object') return false;
                
                // Support v1.0 (PDFs only), v2.0 (PDFs + notes), v3.0 (PDFs + videos + notes), v4.0 (+ labels), and v5.0 (+ summaries)
                if (data.version === '1.0') {
                    return Array.isArray(data.collection);
                }
                
                // For v2.0 and later, check collection and notes
                if (!Array.isArray(data.collection)) return false;
                if (data.notes && !Array.isArray(data.notes)) return false;
                
                // For v3.0 and later, check videos
                if (data.videos && !Array.isArray(data.videos)) return false;
                
                // For v4.0 and later, check labels
                if (data.labels && !Array.isArray(data.labels)) return false;
                
                // For v5.0 and later, check summaries
                if (data.summaries && typeof data.summaries !== 'object') return false;
                
                // Validate each PDF item
                for (const pdf of data.collection) {
                    if (!pdf.id || !pdf.url || !pdf.title || !pdf.dateAdded) {
                        return false;
                    }
                }
                
                // Validate each video item if videos exist
                if (data.videos) {
                    for (const video of data.videos) {
                        if (!video.id || !video.url || !video.title || !video.dateAdded) {
                            return false;
                        }
                    }
                }
                
                // Validate each note item if notes exist
                if (data.notes) {
                    for (const note of data.notes) {
                        if (!note.id || !note.title || !note.content || !note.dateAdded) {
                            return false;
                        }
                    }
                }
                
                // Validate each label item if labels exist
                if (data.labels) {
                    for (const label of data.labels) {
                        if (!label.id || !label.name || !label.color || !label.dateAdded) {
                            return false;
                        }
                    }
                }
                
                // Validate summaries if they exist
                if (data.summaries) {
                    for (const [key, summary] of Object.entries(data.summaries)) {
                        if (!summary.text || !summary.dateAdded) {
                            return false;
                        }
                    }
                }
                
                return true;
            }

            searchSummaries() {
                const searchTerm = this.elements.summarySearchInput.value.trim().toLowerCase();
                
                if (!searchTerm) {
                    this.clearSummarySearch();
                    return;
                }
                
                // Store the search term for highlighting in summaries
                this.currentSearchTerm = searchTerm;
                
                let matchCount = 0;
                const allItems = [...this.pdfCollection, ...this.videoCollection];
                const matchedIds = [];
                
                // Search through summaries
                allItems.forEach(item => {
                    const itemType = this.pdfCollection.includes(item) ? 'pdf' : 'video';
                    const summaryKey = `${itemType}:${item.id}`;
                    const summary = this.summariesCollection[summaryKey];
                    
                    if (summary && summary.text.toLowerCase().includes(searchTerm)) {
                        matchedIds.push({ id: item.id, type: itemType });
                        matchCount++;
                    }
                });
                
                // Highlight matching items
                this.highlightSearchResults(matchedIds);
                
                // Show results info
                this.showSearchResults(matchCount, searchTerm);
            }
            
            highlightSearchResults(matchedIds) {
                // Clear previous highlights
                this.clearSearchHighlights();
                
                // Add highlights to matched items
                matchedIds.forEach(({ id, type }) => {
                    const selector = type === 'pdf' ? 
                        `#pdfGrid .pdf-item[data-id="${id}"]` : 
                        `#videoGrid .video-item[data-id="${id}"]`;
                    const element = document.querySelector(selector);
                    
                    if (element) {
                        element.classList.add('search-highlight');
                    }
                });
                
                // Scroll to first match if any
                if (matchedIds.length > 0) {
                    const firstMatch = document.querySelector('.search-highlight');
                    if (firstMatch) {
                        firstMatch.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }
                }
            }
            
            clearSearchHighlights() {
                const highlighted = document.querySelectorAll('.search-highlight');
                highlighted.forEach(element => {
                    element.classList.remove('search-highlight');
                });
            }
            
            showSearchResults(count, searchTerm) {
                const resultsInfo = this.elements.searchResultsInfo;
                
                if (count > 0) {
                    resultsInfo.innerHTML = `
                        <i class="bi bi-search me-1"></i>
                        Found <strong>${count}</strong> resource${count !== 1 ? 's' : ''} 
                        with summaries containing "<strong>${this.escapeHtml(searchTerm)}</strong>"
                        <br><small class="text-muted">Double-click highlighted thumbnails to see highlighted text in summaries</small>
                    `;
                    resultsInfo.style.display = 'block';
                } else {
                    resultsInfo.innerHTML = `
                        <i class="bi bi-search me-1"></i>
                        No summaries found containing "<strong>${this.escapeHtml(searchTerm)}</strong>"
                    `;
                    resultsInfo.style.display = 'block';
                }
            }
            
            clearSummarySearch() {
                // Clear input
                this.elements.summarySearchInput.value = '';
                
                // Clear search term
                this.currentSearchTerm = '';
                
                // Clear highlights
                this.clearSearchHighlights();
                
                // Hide results info
                this.elements.searchResultsInfo.style.display = 'none';
            }

            openKallidus() {
                const kallidusUrl = 'https://guidedogs.kallidus-suite.com/learn//#/course/6cb80351-2a8c-4e1e-b564-0c8433d6c5e9';
                window.open(kallidusUrl, '_blank');
                this.showNotification('Opening Kallidus Learning Platform...', 'success');
            }
        }

        // Initialize the companion
        const pdfCompanion = new PDFCompanion();

        console.log('💡 Training Collection Manager is ready!');
    </script>
</body>
</html>